{% extends "layout.html" %}

{% block content %}
<div class="h-full flex flex-col space-y-3 overflow-hidden" style="height: calc(100vh - 120px)">

    <!-- Status Bar + Market Hours -->
    <div class="flex space-x-3 flex-shrink-0">
        <!-- Scanner Status -->
        <div class="flex-1 bg-gray-800 rounded-lg p-3 border border-gray-700">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center space-x-2">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
                    <span id="status-label" class="text-xs font-semibold text-gray-400 uppercase">IDLE</span>
                    <span id="status-phase" class="text-xs text-gray-500"></span>
                </div>
                <div class="flex space-x-1">
                    <button onclick="controlScanner('resume')"
                        class="px-2 py-0.5 text-xs bg-green-600 hover:bg-green-500 text-white rounded transition">â–¶
                        Start</button>
                    <button onclick="controlScanner('pause')"
                        class="px-2 py-0.5 text-xs bg-yellow-600 hover:bg-yellow-500 text-white rounded transition">â¸
                        Pause</button>
                    <button onclick="controlScanner('stop')"
                        class="px-2 py-0.5 text-xs bg-red-600 hover:bg-red-500 text-white rounded transition">â¹
                        Stop</button>
                    <button onclick="controlScanner('reset')"
                        class="px-2 py-0.5 text-xs bg-gray-600 hover:bg-gray-500 text-white rounded transition">â†º
                        Reset</button>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full bg-gray-700 rounded-full h-1.5 mb-1">
                <div id="progress-bar" class="bg-blue-500 h-1.5 rounded-full transition-all" style="width:0%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-500">
                <span id="scan-info">ëŒ€ê¸° ì¤‘</span>
                <span id="scan-stats">ë¶„ì„: 0 | í›„ë³´: 0</span>
            </div>
        </div>

        <!-- Market Hours -->
        <div class="w-56 bg-gray-800 rounded-lg p-3 border border-gray-700 flex-shrink-0">
            <h3 class="text-xs font-semibold text-gray-500 mb-2 uppercase">Market Status</h3>
            <div id="market-status" class="space-y-1">
                <div class="text-xs text-gray-500">Loading...</div>
            </div>
        </div>

        <!-- Off-Market Status -->
        <div id="offmarket-panel"
            class="hidden w-48 bg-gray-800 rounded-lg p-3 border border-purple-900/50 flex-shrink-0">
            <h3 class="text-xs font-semibold text-purple-400 mb-2">ğŸŒ™ OFF-MARKET</h3>
            <div id="om-tasks" class="flex items-center space-x-1 mb-1"></div>
            <div id="om-status" class="text-[10px] text-gray-500 truncate">ëŒ€ê¸°</div>
        </div>
    </div>

    <!-- Analysis Results Table -->
    <div class="flex-1 bg-gray-800 rounded-lg border border-gray-700 flex flex-col min-h-0 overflow-hidden">
        <div class="flex items-center justify-between px-3 py-2 border-b border-gray-700 flex-shrink-0">
            <h2 class="text-xs font-semibold text-green-400 uppercase">AI BUY Analysis</h2>
            <div class="flex items-center space-x-2">
                <span id="result-count" class="text-xs text-gray-500">0 ì¢…ëª©</span>
                <!-- í•„í„° ì‚­ì œë¨ -->
                <select id="sort-by" onchange="renderResults()"
                    class="bg-gray-700 text-white text-xs rounded px-2 py-0.5 border border-gray-600">
                    <option value="score">AIì ìˆ˜ â†“</option>
                    <option value="change">ë“±ë½ë¥  â†“</option>
                    <option value="name">ì¢…ëª©ëª…</option>
                </select>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto min-h-0">
            <table class="w-full text-xs">
                <thead class="sticky top-0 bg-gray-800 text-gray-500 z-10">
                    <tr>
                        <th class="px-3 py-1.5 text-left">ì¢…ëª©</th>
                        <th class="px-2 py-1.5 text-right">í˜„ì¬ê°€</th>
                        <th class="px-2 py-1.5 text-right">ë“±ë½ë¥ </th>
                        <th class="px-2 py-1.5 text-center">AIíŒë‹¨</th>
                        <th class="px-2 py-1.5 text-center">ì ìˆ˜</th>
                        <th class="px-2 py-1.5 text-center">ì‹ ë¢°ë„</th>
                        <th class="px-3 py-1.5 text-left">ë¶„ì„ì‚¬ìœ </th>
                        <th class="px-2 py-1.5 text-right">ë¶„ì„ì‹œê°„</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                    <tr>
                        <td colspan="8" class="px-3 py-8 text-center text-gray-600">ìŠ¤ìºë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bottom: Buy Candidates + Scanner Logs -->
    <div class="flex space-x-3 flex-shrink-0" style="height:240px">
        <!-- Buy Candidates (Enhanced) -->
        <div class="flex-1 bg-gray-800 rounded-lg border border-gray-700 flex flex-col overflow-hidden">
            <div class="flex items-center justify-between px-3 py-2 border-b border-gray-700 flex-shrink-0">
                <h2 class="text-xs font-semibold text-green-500 uppercase">ğŸ¯ Buy Candidates</h2>
                <span id="candidate-count" class="text-xs text-gray-500">0ê°œ</span>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1.5 min-h-0" id="candidates-container">
                <div class="text-xs text-gray-600 p-2">ë§¤ìˆ˜ í›„ë³´ ì—†ìŒ</div>
            </div>
        </div>

        <!-- Scanner Logs -->
        <div class="flex-1 bg-gray-800 rounded-lg border border-gray-700 flex flex-col overflow-hidden">
            <h2 class="text-xs font-semibold text-gray-500 uppercase px-3 py-2 border-b border-gray-700 flex-shrink-0">
                Scanner Logs
            </h2>
            <div class="flex-1 overflow-y-auto font-mono text-xs p-2 bg-gray-900 rounded-b-lg min-h-0"
                id="scanner-logs">
                <div class="text-gray-500">Connecting...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // â”€â”€â”€ State â”€â”€â”€
    let allResults = [];

    // â”€â”€â”€ Color Maps â”€â”€â”€
    const ACTION_COLORS = {
        BUY: { bg: 'bg-green-900/50', text: 'text-green-400', badge: 'bg-green-600' },
        HOLD: { bg: 'bg-gray-800', text: 'text-yellow-400', badge: 'bg-yellow-600' },
        AVOID: { bg: 'bg-red-900/30', text: 'text-red-400', badge: 'bg-red-600' },
        ERROR: { bg: 'bg-gray-800', text: 'text-gray-500', badge: 'bg-gray-600' },
    };

    const LOG_COLORS = {
        SYSTEM: 'text-green-400', INFO: 'text-gray-400', SCAN: 'text-cyan-400',
        BULL: 'text-red-400', BEAR: 'text-blue-400', ALERT: 'text-orange-400',
        TOKEN: 'text-yellow-400', WARN: 'text-yellow-500', ERROR: 'text-red-500',
    };

    const TRACKING_STATUS = {
        watching: { icon: 'ğŸ“¡', text: 'ì¶”ì ì¤‘', color: 'text-blue-400' },
        analyzing: { icon: 'ğŸ§ ', text: 'AI ë¶„ì„ì¤‘', color: 'text-purple-400' },
        ordering: { icon: 'ğŸ¯', text: 'ì£¼ë¬¸ì¤‘', color: 'text-orange-400' },
        filled: { icon: 'âœ…', text: 'ì²´ê²°', color: 'text-green-400' },
    };

    // â”€â”€â”€ í†µí™” ê¸°í˜¸ ë§¤í•‘ â”€â”€â”€
    const CURRENCY_MAP = {
        'US': '$', 'NASD': '$', 'NYSE': '$', 'AMEX': '$',
        'JP': 'Â¥', 'TKSE': 'Â¥',
        'HK': 'HK$', 'SEHK': 'HK$',
        'CN': 'Â¥', 'SHAA': 'Â¥', 'SZAA': 'Â¥',
        'KR': 'â‚©', 'KRX': 'â‚©', 'KOSPI': 'â‚©', 'KOSDAQ': 'â‚©',
        'UK': 'Â£', 'LNSE': 'Â£',
        'VN': 'â‚«', 'HASE': 'â‚«', 'VNSE': 'â‚«',
    };
    function getCcy(market) { return CURRENCY_MAP[market] || '$'; }
    function fmtPrice(price, market, decimals) {
        const ccy = getCcy(market);
        const d = decimals !== undefined ? decimals :
            (market === 'JP' || market === 'TKSE') ? 0 :
                (market === 'KR' || market === 'KRX' || market === 'KOSPI' || market === 'KOSDAQ') ? 0 :
                    (market === 'CN' || market === 'SHAA' || market === 'SZAA') ? 2 : 2;
        return ccy + (price || 0).toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
    }

    // â”€â”€â”€ Scanner State Polling â”€â”€â”€
    async function updateScannerState() {
        try {
            const res = await fetch('/api/scanner/state');
            const s = await res.json();

            // Status dot
            const dot = document.getElementById('status-dot');
            const label = document.getElementById('status-label');
            const phase = document.getElementById('status-phase');

            if (s.status === 'scanning') {
                dot.className = 'w-2 h-2 rounded-full bg-green-400 animate-pulse';
                label.textContent = 'SCANNING';
                label.className = 'text-xs font-semibold text-green-400 uppercase';
            } else if (s.status === 'paused') {
                dot.className = 'w-2 h-2 rounded-full bg-yellow-400';
                label.textContent = 'PAUSED';
                label.className = 'text-xs font-semibold text-yellow-400 uppercase';
            } else if (s.status === 'stopped') {
                dot.className = 'w-2 h-2 rounded-full bg-red-400';
                label.textContent = 'STOPPED';
                label.className = 'text-xs font-semibold text-red-400 uppercase';
            } else {
                dot.className = 'w-2 h-2 rounded-full bg-gray-500';
                label.textContent = 'IDLE';
                label.className = 'text-xs font-semibold text-gray-400 uppercase';
            }

            // Phase
            const phaseMap = {
                target_select: 'ì¢…ëª© ì„ ì •', candle_collect: 'ì°¨íŠ¸ ìˆ˜ì§‘',
                ai_analysis: 'AI ë¶„ì„', closing: 'ë§ˆê° ë¶„ì„', waiting: 'ëŒ€ê¸°',
                offmarket: 'ğŸŒ™ Off-Market',
            };
            phase.textContent = phaseMap[s.phase] || s.phase || '';

            // Off-Market ìƒíƒœ ì—…ë°ì´íŠ¸
            const omPanel = document.getElementById('offmarket-panel');
            if (s.offmarket) {
                const om = s.offmarket;
                if (om.status === 'running' || om.status === 'done') {
                    omPanel.classList.remove('hidden');
                    const taskIcons = ['ğŸ“Š', 'ğŸ“°', 'ğŸ¯', 'ğŸ”¬', 'ğŸŒ', 'â­'];
                    const taskNames = ['ìº”ë“¤ìˆ˜ì§‘', 'ë‰´ìŠ¤', 'AIì •í™•ë„', 'ê¸°ìˆ ë¶„ì„', 'ê¸€ë¡œë²Œ', 'í”„ë¦¬ë§ˆì¼“'];
                    let dotsHtml = taskIcons.map((icon, i) => {
                        const done = (i + 1) <= (om.progress || 0);
                        const active = (i + 1) === (om.progress || 0) && om.status === 'running';
                        return `<span class="${done ? 'text-green-400' : 'text-gray-600'} ${active ? 'animate-pulse' : ''} text-xs" title="${taskNames[i]}">${icon}</span>`;
                    }).join(' ');
                    document.getElementById('om-tasks').innerHTML = dotsHtml;
                    document.getElementById('om-status').textContent = om.status === 'running' ? om.current_task : 'âœ… ì™„ë£Œ';
                    document.getElementById('om-status').className = om.status === 'running' ? 'text-[10px] text-yellow-400 truncate animate-pulse' : 'text-[10px] text-green-400 truncate';
                } else {
                    omPanel.classList.add('hidden');
                }
            }

            // Progress
            document.getElementById('progress-bar').style.width = s.progress + '%';

            // Info
            const info = s.current_stock ? `ë¶„ì„ ì¤‘: ${s.current_stock}` : (s.phase === 'waiting' ? 'ì¥ ì˜¤í”ˆ ëŒ€ê¸° ì¤‘' : 'ëŒ€ê¸° ì¤‘');
            document.getElementById('scan-info').textContent = info;
            document.getElementById('scan-stats').textContent = `ë¶„ì„: ${s.analyzed_count || 0} | ì”ê³ ë¶€ì¡±: ${s.skipped_by_budget || 0} | í›„ë³´: ${s.candidates_count || 0} | ì‚¬ì´í´: ${s.cycle_count || 0}`;

            // Market Status
            if (s.market_status) {
                const container = document.getElementById('market-status');
                container.innerHTML = '';
                for (const [code, ms] of Object.entries(s.market_status)) {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between text-xs';
                    const statusColor = ms.active ? 'text-green-400' : 'text-gray-600';
                    const statusIcon = ms.active ? 'ğŸŸ¢' : 'ğŸ”´';
                    div.innerHTML = `<span class="${statusColor}">${ms.flag} ${ms.name}</span><span class="text-gray-500">${ms.hours} ${statusIcon}</span>`;
                    container.appendChild(div);
                }
            }

        } catch (e) { }
    }

    // â”€â”€â”€ Results Polling â”€â”€â”€
    async function fetchResults() {
        try {
            const res = await fetch('/api/scanner/results?limit=200');
            const data = await res.json();
            allResults = data.results || [];
            renderResults();
        } catch (e) { }
    }

    async function renderResults() {
        // const filter = document.getElementById('filter-action').value; (ì‚­ì œë¨)
        const sortKey = document.getElementById('sort-by').value;
        const tbody = document.getElementById('results-body');

        let filtered = allResults;
        // if (filter !== 'all') {
        //     filtered = filtered.filter(r => r.ai_action === filter);
        // }

        // Sort
        if (sortKey === 'score') {
            filtered.sort((a, b) => (b.ai_score || 0) - (a.ai_score || 0));
        } else if (sortKey === 'change') {
            filtered.sort((a, b) => (b.change_rate || 0) - (a.change_rate || 0));
        } else {
            filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        }

        document.getElementById('result-count').textContent = `${filtered.length} ì¢…ëª©`;

        if (filtered.length === 0) {
            let emptyMsg = 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ';
            try {
                const stRes = await fetch('/api/scanner/state');
                const st = await stRes.json();
                if (st.skipped_by_budget > 0) {
                    emptyMsg = `ğŸ’¸ ì”ê³  ë¶€ì¡±ìœ¼ë¡œ ${st.skipped_by_budget}ê°œ ì¢…ëª©ì´ í•„í„°ë§ë˜ì—ˆìŠµë‹ˆë‹¤<br>`
                        + `ì˜ˆìˆ˜ê¸ˆ: ${(st.available_cash || 0).toLocaleString()}ì›`;
                    if (st.cheapest_skipped) {
                        emptyMsg += `<br>ìµœì €ê°€ ì¢…ëª©: ${st.cheapest_skipped}`;
                    }
                    emptyMsg += `<br><span class="text-gray-600 text-[10px]">ì”ê³ ë¥¼ ì¶”ê°€í•˜ë©´ ë” ë§ì€ ì¢…ëª©ì´ ë¶„ì„ë©ë‹ˆë‹¤</span>`;
                }
            } catch (e) { }
            tbody.innerHTML = `<tr><td colspan="8" class="px-3 py-8 text-center text-gray-500">${emptyMsg}</td></tr>`;
            return;
        }

        tbody.innerHTML = filtered.map(r => {
            const ac = ACTION_COLORS[r.ai_action] || ACTION_COLORS.ERROR;
            const chgColor = (r.change_rate || 0) > 0 ? 'text-red-400' : ((r.change_rate || 0) < 0 ? 'text-blue-400' : 'text-gray-400');
            const chgPrefix = (r.change_rate || 0) > 0 ? '+' : '';
            const scoreColor = (r.ai_score || 0) >= 80 ? 'text-green-400' : ((r.ai_score || 0) >= 50 ? 'text-yellow-400' : 'text-gray-500');

            return `<tr class="${ac.bg} border-b border-gray-700/50 hover:bg-gray-700/30 transition">
                <td class="px-3 py-1.5">
                    <div class="text-white font-medium">${r.name || '-'}</div>
                    <div class="text-gray-500">${r.symbol || ''} Â· ${r.market || ''}</div>
                </td>
                <td class="px-2 py-1.5 text-right text-white font-mono">${fmtPrice(r.price, r.market)}</td>
                <td class="px-2 py-1.5 text-right font-mono ${chgColor}">${chgPrefix}${(r.change_rate || 0).toFixed(2)}%</td>
                <td class="px-2 py-1.5 text-center">
                    <span class="px-1.5 py-0.5 rounded text-xs font-bold text-white ${ac.badge}">${r.ai_action || '-'}</span>
                </td>
                <td class="px-2 py-1.5 text-center font-bold ${scoreColor}">${r.ai_score || 0}</td>
                <td class="px-2 py-1.5 text-center text-gray-400">${r.ai_confidence || 0}%</td>
                <td class="px-3 py-1.5 text-gray-400 max-w-xs truncate" title="${(r.ai_reason || '').replace(/"/g, '&quot;')}">${r.ai_reason || '-'}</td>
                <td class="px-2 py-1.5 text-right text-gray-500">${r.analyzed_at || ''}</td>
            </tr>`;
        }).join('');
    }

    // â”€â”€â”€ Candidates Polling (Enhanced with real-time tracking) â”€â”€â”€
    async function fetchCandidates() {
        try {
            const res = await fetch('/api/scanner/candidates');
            const data = await res.json();
            const container = document.getElementById('candidates-container');
            const countEl = document.getElementById('candidate-count');
            const candidates = data.candidates || [];

            countEl.textContent = `${candidates.length}ê°œ`;

            if (candidates.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-600 p-2">ë§¤ìˆ˜ í›„ë³´ ì—†ìŒ</div>';
                return;
            }

            container.innerHTML = candidates.slice(0, 15).map(c => {
                const livePrice = c.live_price || c.price || 0;
                const chgColor = (c.live_change || c.change_rate || 0) > 0 ? 'text-red-400' : 'text-blue-400';
                const chg = c.live_change || c.change_rate || 0;
                const status = TRACKING_STATUS[c.tracking_status] || TRACKING_STATUS.watching;
                const predPrice = c.predicted_buy_price || 0;
                const tradeType = c.buy_trade_type || '';
                const riskLevel = c.buy_risk_level || 0;
                const recQty = c.buy_recommended_qty || 0;
                const stopLoss = c.buy_stop_loss || 0;
                const targetPrice = c.buy_target_price || 0;
                const buyReason = c.buy_reason || '';

                // Trade type badge
                let tradeBadge = '';
                if (tradeType === 'ë‹¨íƒ€') {
                    tradeBadge = '<span class="px-1 py-0.5 rounded text-[9px] bg-orange-900/50 text-orange-300 font-bold">âš¡ë‹¨íƒ€</span>';
                } else if (tradeType === 'ìŠ¤ìœ™') {
                    tradeBadge = '<span class="px-1 py-0.5 rounded text-[9px] bg-blue-900/50 text-blue-300 font-bold">ğŸ“ˆìŠ¤ìœ™</span>';
                }

                // Risk level color
                const riskColor = riskLevel >= 7 ? 'text-red-400' : riskLevel >= 4 ? 'text-yellow-400' : 'text-green-400';

                // Price progress bar (current vs predicted)
                let progressHtml = '';
                if (predPrice > 0 && livePrice > 0) {
                    const ratio = Math.min(100, Math.max(0, ((predPrice / livePrice) * 100)));
                    const nearTarget = livePrice <= predPrice * 1.02;
                    const barColor = nearTarget ? 'bg-green-500' : 'bg-blue-500';
                    progressHtml = `
                        <div class="w-full bg-gray-700 rounded-full h-1 mt-1">
                            <div class="${barColor} h-1 rounded-full transition-all" style="width:${ratio}%"></div>
                        </div>`;
                }

                // Border color based on status
                const borderColor = c.tracking_status === 'filled' ? 'border-green-500/60' :
                    c.tracking_status === 'ordering' ? 'border-orange-500/60' :
                        'border-green-800/50';

                // AI strategy info line
                let strategyHtml = '';
                if (predPrice > 0 && riskLevel > 0) {
                    strategyHtml = `
                        <div class="flex items-center justify-between mt-1.5 pt-1 border-t border-gray-700/50">
                            <div class="flex items-center space-x-2">
                                ${tradeBadge}
                                <span class="${riskColor} text-[10px] font-mono">ìœ„í—˜${riskLevel}/10</span>
                                <span class="text-gray-400 text-[10px]">${recQty}ì£¼</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${stopLoss > 0 ? `<span class="text-red-400 text-[10px] font-mono">S/L ${fmtPrice(stopLoss, c.market)}</span>` : ''}
                                ${targetPrice > 0 ? `<span class="text-green-400 text-[10px] font-mono">T/P ${fmtPrice(targetPrice, c.market)}</span>` : ''}
                            </div>
                        </div>`;
                    if (buyReason) {
                        strategyHtml += `<div class="text-[9px] text-gray-500 mt-0.5 truncate" title="${buyReason}">${buyReason.substring(0, 50)}...</div>`;
                    }
                }

                return `<div class="bg-green-900/20 rounded-lg p-2.5 border ${borderColor} transition-all">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <span class="text-white font-medium text-xs">${c.name || c.symbol}</span>
                            <span class="text-gray-500 text-[10px]">${c.symbol}</span>
                        </div>
                        <div class="flex items-center space-x-1.5">
                            <span class="${status.color} text-[10px] font-semibold">${status.icon} ${status.text}</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-1.5">
                        <div class="flex items-center space-x-3">
                            <div>
                                <div class="text-[10px] text-gray-500">í˜„ì¬ê°€</div>
                                <div class="text-white font-mono text-xs">${fmtPrice(livePrice, c.market)}</div>
                            </div>
                            ${predPrice > 0 ? `
                            <div>
                                <div class="text-[10px] text-blue-400">AI ë§¤ìˆ˜ê°€</div>
                                <div class="text-blue-300 font-mono text-xs font-bold">${fmtPrice(predPrice, c.market)}</div>
                            </div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-[9px] text-gray-500">${c.tracking_status === 'filled' ? 'ìˆ˜ìµë¥ ' : 'ë“±ë½ë¥ '}</div>
                            <span class="${chgColor} text-xs font-mono font-bold">${chg > 0 ? '+' : ''}${chg.toFixed(1)}%</span>
                            <div class="text-green-400 text-[10px]">Score:${c.ai_score || 0}</div>
                        </div>
                    </div>
                    ${progressHtml}
                    ${strategyHtml}
                    ${c.last_updated ? `<div class="text-[9px] text-gray-600 mt-0.5 text-right">${c.last_updated} ê°±ì‹ </div>` : ''}
                    ${c.tracking_status === 'filled' ? `<div class="text-[10px] text-green-400 mt-1 font-semibold">âœ… ${c.order_qty || 1}ì£¼ @${fmtPrice(c.order_price, c.market)} ì²´ê²° (${c.ordered_at || ''})</div>` : ''}
                </div>`;
            }).join('');
        } catch (e) { }
    }

    // â”€â”€â”€ Scanner Control â”€â”€â”€
    async function controlScanner(action) {
        try {
            await fetch('/api/scanner/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action }),
            });
            updateScannerState();
        } catch (e) { }
    }

    // â”€â”€â”€ SSE Log Stream â”€â”€â”€
    function connectScannerLogs() {
        const logEl = document.getElementById('scanner-logs');
        const evtSrc = new EventSource('/api/scanner/stream');
        let first = true;

        evtSrc.onmessage = (event) => {
            try {
                const entry = JSON.parse(event.data);
                if (entry.level === 'ping') return;
                if (first) { logEl.innerHTML = ''; first = false; }

                const color = LOG_COLORS[entry.level] || 'text-gray-400';
                const div = document.createElement('div');
                div.className = color;
                div.textContent = `[${entry.time}] [${entry.level}] ${entry.message}`;
                logEl.appendChild(div);

                while (logEl.children.length > 200) logEl.removeChild(logEl.firstChild);
                logEl.scrollTop = logEl.scrollHeight;
            } catch (e) { }
        };

        evtSrc.onerror = () => {
            evtSrc.close();
            const div = document.createElement('div');
            div.className = 'text-yellow-500';
            div.textContent = `[${new Date().toLocaleTimeString()}] ì—°ê²° ëŠê¹€ â€” ì¬ì—°ê²° ì¤‘...`;
            logEl.appendChild(div);
            setTimeout(connectScannerLogs, 3000);
        };
    }

    // â”€â”€â”€ Init â”€â”€â”€
    updateScannerState();
    fetchResults();
    fetchCandidates();
    connectScannerLogs();

    setInterval(updateScannerState, 5000);
    setInterval(fetchResults, 10000);
    setInterval(fetchCandidates, 8000);  // 8ì´ˆ ê°„ê²© (ì‹¤ì‹œê°„ ì¶”ì )
</script>
{% endblock %}