{% extends "layout.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-6 gap-4" id="summary-cards">
        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
            <div class="text-xs text-gray-400 uppercase">ì´ìì‚°</div>
            <div class="text-xl font-bold text-white" id="total-assets">-</div>
            <div class="text-xs text-gray-500 mt-1" id="total-assets-detail"></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
            <div class="text-xs text-gray-400 uppercase">ì£¼ë¬¸ê°€ëŠ¥(ì›í™”)</div>
            <div class="text-xl font-bold text-green-400" id="order-available">-</div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
            <div class="text-xs text-gray-400 uppercase">ì£¼ë¬¸ê°€ëŠ¥(ì™¸í™”)</div>
            <div class="text-xl font-bold text-cyan-400" id="usd-available">-</div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
            <div class="text-xs text-gray-400 uppercase">êµ­ë‚´í‰ê°€ê¸ˆì•¡</div>
            <div class="text-xl font-bold text-white" id="cash-amount">-</div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
            <div class="text-xs text-gray-400 uppercase">í•´ì™¸í‰ê°€(USD)</div>
            <div class="text-xl font-bold text-cyan-400" id="overseas-eval">-</div>
            <div class="text-xs text-gray-500 mt-1" id="fx-rate-info"></div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
            <div class="text-xs text-gray-400 uppercase">ë³´ìœ ì¢…ëª©</div>
            <div class="text-xl font-bold text-blue-400"><span id="holdings-count">0</span><span
                    class="text-sm text-gray-500 ml-1">ì¢…ëª©</span></div>
            <div class="text-xs text-gray-500 mt-1">ë§¤ë„ì¶”ì  <span id="sell-tracking-count" class="text-yellow-400">0</span>
            </div>
        </div>
    </div>


    <!-- Unified Holdings with AI Sell Tracking (scrollable) -->
    <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
            <span class="font-bold text-sm text-gray-300 uppercase">ğŸ“Š ë³´ìœ ì¢…ëª© (AI ë§¤ë„ ì¶”ì )</span>
            <div class="flex gap-2">
                <span class="text-xs text-gray-500" id="holdings-updated">-</span>
                <button onclick="refreshHoldings()"
                    class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded transition">â†»
                    ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>
        <div class="overflow-x-auto" style="max-height: 340px; overflow-y: auto;">
            <table class="w-full text-sm text-left text-gray-300">
                <thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0 z-10">
                    <tr>
                        <th class="px-3 py-3">ì¢…ëª©</th>
                        <th class="px-3 py-3 text-center">ì „ëµ</th>
                        <th class="px-3 py-3 text-right">ìˆ˜ëŸ‰</th>
                        <th class="px-3 py-3 text-right">ë§¤ìˆ˜ê°€</th>
                        <th class="px-3 py-3 text-right">í˜„ì¬ê°€</th>
                        <th class="px-3 py-3 text-right">ìˆ˜ìµë¥ </th>
                        <th class="px-3 py-3 text-center">AI ë§¤ë„</th>
                        <th class="px-3 py-3 text-right">ì†ì ˆì„ </th>
                        <th class="px-3 py-3 text-right">ì†ìµë¶„ê¸°</th>
                        <th class="px-3 py-3 text-right">ìˆ˜ìˆ˜ë£Œ</th>
                        <th class="px-3 py-3 text-right">ìˆœì´ìµ</th>
                        <th class="px-3 py-3 text-center">ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="holdings-body">
                    <tr>
                        <td colspan="12" class="px-4 py-6 text-center text-gray-600">ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Trade Log + Pending Orders: side-by-side -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Trade Log (left half) -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-700">
                <span class="font-bold text-sm text-gray-300 uppercase">ğŸ“‹ ìë™ë§¤ë§¤ ê±°ë˜ê¸°ë¡</span>
            </div>
            <div style="max-height: 280px; overflow-y: auto;">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-2">ì‹œê°„</th>
                            <th class="px-3 py-2">ì¢…ëª©</th>
                            <th class="px-3 py-2 text-center">êµ¬ë¶„</th>
                            <th class="px-3 py-2 text-right">ìˆ˜ëŸ‰</th>
                            <th class="px-3 py-2 text-right">ë‹¨ê°€</th>
                            <th class="px-3 py-2">ì£¼ë¬¸ë²ˆí˜¸</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body">
                        <tr>
                            <td colspan="6" class="px-4 py-6 text-center text-gray-600">ê±°ë˜ ê¸°ë¡ ì—†ìŒ</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pending Orders (right half) -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
                <span class="font-bold text-sm text-gray-300 uppercase">â³ ë¯¸ì²´ê²° ì£¼ë¬¸</span>
                <span class="text-xs text-gray-500" id="pending-count">0ê±´</span>
            </div>
            <div style="max-height: 280px; overflow-y: auto;">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-2">ì¢…ëª©</th>
                            <th class="px-3 py-2 text-center">ìƒíƒœ</th>
                            <th class="px-3 py-2 text-right">ìˆ˜ëŸ‰</th>
                            <th class="px-3 py-2 text-right">ì£¼ë¬¸ê°€</th>
                            <th class="px-3 py-2">ì£¼ë¬¸ì‹œê°„</th>
                            <th class="px-3 py-2">ì£¼ë¬¸ë²ˆí˜¸</th>
                        </tr>
                    </thead>
                    <tbody id="pending-body">
                        <tr>
                            <td colspan="6" class="px-4 py-6 text-center text-gray-600">ë¯¸ì²´ê²° ì£¼ë¬¸ ì—†ìŒ</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function formatKRW(val) {
        if (!val && val !== 0) return '-';
        return Math.round(val).toLocaleString() + 'ì›';
    }

    // â”€â”€â”€ í†µí™” ê¸°í˜¸ ë§¤í•‘ â”€â”€â”€
    const CURRENCY_MAP = {
        'US': '$', 'NASD': '$', 'NYSE': '$', 'AMEX': '$',
        'JP': 'Â¥', 'TKSE': 'Â¥',
        'HK': 'HK$', 'SEHK': 'HK$',
        'CN': 'Â¥', 'SHAA': 'Â¥', 'SZAA': 'Â¥',
        'KR': 'â‚©', 'KRX': 'â‚©', 'KOSPI': 'â‚©', 'KOSDAQ': 'â‚©',
        'UK': 'Â£', 'LNSE': 'Â£',
        'VN': 'â‚«', 'HASE': 'â‚«', 'VNSE': 'â‚«',
    };
    function getCcy(exch) { return CURRENCY_MAP[exch] || '$'; }
    function fmtPrice(price, exch, decimals) {
        const ccy = getCcy(exch);
        const d = decimals !== undefined ? decimals :
            (exch === 'JP' || exch === 'TKSE') ? 0 :
                (exch === 'KR' || exch === 'KRX' || exch === 'KOSPI' || exch === 'KOSDAQ') ? 0 :
                    (exch === 'CN' || exch === 'SHAA' || exch === 'SZAA') ? 2 : 2;
        return ccy + (price || 0).toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
    }

    function sellStatusBadge(status) {
        const badges = {
            'watching': '<span class="px-1.5 py-0.5 rounded text-xs bg-gray-600 text-gray-300">ğŸ‘ ê°ì‹œ</span>',
            'analyzing': '<span class="px-1.5 py-0.5 rounded text-xs bg-purple-900/50 text-purple-300 animate-pulse">ğŸ§  ë¶„ì„ì¤‘</span>',
            'selling': '<span class="px-1.5 py-0.5 rounded text-xs bg-yellow-900/50 text-yellow-300 animate-pulse">ğŸ·ï¸ ì£¼ë¬¸ì¤‘</span>',
            'sold': '<span class="px-1.5 py-0.5 rounded text-xs bg-green-900/50 text-green-300">âœ… ì²´ê²°</span>',
        };
        return badges[status] || badges['watching'];
    }

    async function refreshHoldings() {
        try {
            const res = await fetch('/api/portfolio/holdings');
            const data = await res.json();

            // Summary cards
            document.getElementById('total-assets').textContent = formatKRW(data.total_assets);
            document.getElementById('order-available').textContent = formatKRW(data.order_available);
            document.getElementById('cash-amount').textContent = formatKRW(data.domestic_eval);

            // USD ì£¼ë¬¸ê°€ëŠ¥
            const usdAvail = data.usd_order_available || 0;
            document.getElementById('usd-available').textContent = usdAvail > 0 ? '$' + usdAvail.toFixed(2) : '$0.00';

            // ì´ìì‚° ë‚´ì—­
            const parts = [];
            if (data.order_available) parts.push('ì£¼ë¬¸ê°€ëŠ¥ ' + formatKRW(data.order_available));
            if (data.domestic_eval) parts.push('êµ­ë‚´ ' + formatKRW(data.domestic_eval));
            document.getElementById('total-assets-detail').textContent = parts.join(' + ') || '';

            // í•´ì™¸í‰ê°€ (USD)
            const overseasUsd = data.overseas_eval_usd || 0;
            document.getElementById('overseas-eval').textContent = overseasUsd > 0 ? '$' + overseasUsd.toFixed(2) : '-';
            const fxRate = data.fx_rate || 0;
            document.getElementById('fx-rate-info').textContent = fxRate > 0 ? 'í™˜ìœ¨ â‚©' + Math.round(fxRate).toLocaleString() : '';

            const holdings = data.holdings || [];
            document.getElementById('holdings-count').textContent = holdings.length;

            // Sell tracking count
            const trackingCount = holdings.filter(h => h.sell_status && h.sell_status !== 'watching').length;
            document.getElementById('sell-tracking-count').textContent = trackingCount || holdings.length;

            // Unified holdings table
            const hBody = document.getElementById('holdings-body');
            if (holdings.length === 0) {
                hBody.innerHTML = '<tr><td colspan="12" class="px-4 py-6 text-center text-gray-600">ë³´ìœ ì¢…ëª© ì—†ìŒ</td></tr>';
            } else {
                hBody.innerHTML = holdings.map(h => {
                    const isDomestic = h.market_type === 'domestic' || h.exchange === 'KRX';
                    const marketFlag = isDomestic ? 'ğŸ‡°ğŸ‡·' : 'ğŸŒ';
                    const exch = h.exchange || (isDomestic ? 'KRX' : 'NASD');
                    const profitRate = h.profit_rate || 0;
                    const plColor = profitRate >= 0 ? 'text-red-400' : 'text-blue-400';
                    const plPrefix = profitRate >= 0 ? '+' : '';
                    const netProfit = h.net_profit || h.profit_amount || 0;
                    const netProfitRate = h.net_profit_rate || 0;
                    const npColor = netProfit >= 0 ? 'text-green-400' : 'text-red-500';
                    const npPrefix = netProfit >= 0 ? '+' : '-';
                    const avgPrice = h.avg_price || 0;
                    const curPrice = h.current_price || h.live_price || 0;
                    const breakEven = h.break_even_price || 0;
                    const totalFees = h.total_fees || 0;
                    const sellPrice = h.ai_sell_price || 0;
                    const sellAction = h.ai_sell_action || '';
                    const sellReason = h.ai_sell_reason || '';
                    const tradeType = h.trade_type || '';
                    const stopLoss = h.stop_loss || 0;
                    const targetProfitRate = h.target_profit_rate || 0;
                    const holdDuration = h.hold_duration || '';

                    // ì „ëµ ë±ƒì§€
                    let tradeBadge = '<span class="text-gray-600 text-xs">-</span>';
                    if (tradeType === 'ë‹¨íƒ€') {
                        tradeBadge = '<span class="px-1.5 py-0.5 rounded text-xs bg-orange-900/50 text-orange-300 font-bold">âš¡ ë‹¨íƒ€</span>';
                    } else if (tradeType === 'ìŠ¤ìœ™') {
                        tradeBadge = '<span class="px-1.5 py-0.5 rounded text-xs bg-blue-900/50 text-blue-300 font-bold">ğŸ“ˆ ìŠ¤ìœ™</span>';
                    }

                    // AI ë§¤ë„ íŒë‹¨ í‘œì‹œ
                    let aiSellCell = '<span class="text-gray-600">ëŒ€ê¸°</span>';
                    if (sellPrice > 0) {
                        const actionColor = sellAction === 'SELL' ? 'text-red-400' : 'text-yellow-400';
                        const actionIcon = sellAction === 'SELL' ? 'ğŸ”´' : 'ğŸŸ¡';
                        aiSellCell = `<div class="${actionColor} font-mono font-bold text-xs">${actionIcon} ${fmtPrice(sellPrice, exch)}</div>`;
                        if (targetProfitRate) {
                            aiSellCell += `<div class="text-gray-500 text-xs">ëª©í‘œ ${targetProfitRate > 0 ? '+' : ''}${targetProfitRate.toFixed(1)}%</div>`;
                        }
                        if (sellReason) {
                            aiSellCell += `<div class="text-gray-500 text-xs truncate max-w-[120px]" title="${sellReason}${holdDuration ? ' | ë³´ìœ : ' + holdDuration : ''}">${sellReason.substring(0, 30)}...</div>`;
                        }
                    }

                    const feeDecimals = isDomestic ? 0 : 4;

                    return `<tr class="border-b border-gray-700 hover:bg-gray-700/50 transition">
                        <td class="px-3 py-3">
                            <div class="font-bold text-white">${marketFlag} ${h.name || h.symbol}</div>
                            <div class="text-xs text-gray-500">${h.symbol} Â· ${exch}</div>
                        </td>
                        <td class="px-3 py-3 text-center">${tradeBadge}</td>
                        <td class="px-3 py-3 text-right font-mono">${h.quantity}</td>
                        <td class="px-3 py-3 text-right font-mono text-gray-400">${fmtPrice(avgPrice, exch)}</td>
                        <td class="px-3 py-3 text-right font-mono text-white">${fmtPrice(curPrice, exch)}</td>
                        <td class="px-3 py-3 text-right font-mono ${plColor}">${plPrefix}${profitRate.toFixed(2)}%</td>
                        <td class="px-3 py-3 text-center">${aiSellCell}</td>
                        <td class="px-3 py-3 text-right font-mono text-red-400 text-xs">${stopLoss > 0 ? fmtPrice(stopLoss, exch) : '-'}</td>
                        <td class="px-3 py-3 text-right font-mono text-gray-400 text-xs">${breakEven > 0 ? fmtPrice(breakEven, exch) : '-'}</td>
                        <td class="px-3 py-3 text-right font-mono text-orange-400 text-xs">${totalFees > 0 ? fmtPrice(totalFees, exch, feeDecimals) : '-'}</td>
                        <td class="px-3 py-3 text-right font-mono ${npColor} font-bold">${npPrefix}${fmtPrice(Math.abs(netProfit), exch)}<br><span class="text-xs opacity-70">${npPrefix}${Math.abs(netProfitRate).toFixed(2)}%</span></td>
                        <td class="px-3 py-3 text-center">${sellStatusBadge(h.sell_status || 'watching')}</td>
                    </tr>`;
                }).join('');
            }

            // Update timestamp
            document.getElementById('holdings-updated').textContent =
                new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        } catch (e) {
            console.error('Holdings fetch error:', e);
        }
    }

    async function refreshTrades() {
        try {
            const res = await fetch('/api/scanner/trades');
            const data = await res.json();
            const tbody = document.getElementById('trades-body');
            const trades = data.trades || [];

            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-600">ê±°ë˜ ê¸°ë¡ ì—†ìŒ</td></tr>';
                return;
            }

            tbody.innerHTML = trades.map(t => {
                const sideColor = t.side === 'buy' ? 'text-red-400' : 'text-blue-400';
                const sideText = t.side === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
                const exch = t.market === 'KR' ? 'KRX' : t.market || 'NASD';
                return `<tr class="border-b border-gray-700 hover:bg-gray-700/50 transition">
                    <td class="px-3 py-2 text-gray-400 text-xs whitespace-nowrap">${(t.time || '').substring(5)}</td>
                    <td class="px-3 py-2">
                        <span class="text-white font-medium text-xs">${t.name}</span>
                    </td>
                    <td class="px-3 py-2 text-center ${sideColor} font-bold text-xs">${sideText}</td>
                    <td class="px-3 py-2 text-right font-mono text-xs">${t.qty}</td>
                    <td class="px-3 py-2 text-right font-mono text-xs">${fmtPrice(t.price, exch)}</td>
                    <td class="px-3 py-2 text-gray-500 text-xs font-mono">${(t.order_no || '-').substring(0, 10)}</td>
                </tr>`;
            }).join('');
        } catch (e) { }
    }

    async function refreshPending() {
        try {
            const res = await fetch('/api/portfolio/pending');
            const data = await res.json();
            const pending = data.pending || [];

            document.getElementById('pending-count').textContent = pending.length + 'ê±´';
            const tbody = document.getElementById('pending-body');

            if (pending.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-center text-gray-600">ë¯¸ì²´ê²° ì£¼ë¬¸ ì—†ìŒ</td></tr>';
                return;
            }

            tbody.innerHTML = pending.map(p => {
                const isDomestic = p.market_type === 'domestic';
                const exch = p.exchange || (isDomestic ? 'KRX' : 'NASD');
                const sideColor = p.side === 'buy' ? 'text-red-400' : 'text-blue-400';
                const sideText = p.side === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
                const statusBadge = `<span class="px-1.5 py-0.5 rounded text-xs bg-yellow-900/50 text-yellow-300 animate-pulse">â³ ${sideText}</span>`;
                // ì£¼ë¬¸ì‹œê°„ í¬ë§· (HHMMSS â†’ HH:MM:SS)
                let timeStr = p.order_time || '';
                if (timeStr.length === 6) {
                    timeStr = timeStr.substring(0, 2) + ':' + timeStr.substring(2, 4) + ':' + timeStr.substring(4, 6);
                }
                return `<tr class="border-b border-gray-700 hover:bg-gray-700/50 transition">
                    <td class="px-3 py-2">
                        <div class="text-white font-medium text-xs">${isDomestic ? 'ğŸ‡°ğŸ‡·' : 'ğŸŒ'} ${p.name || p.symbol}</div>
                        <div class="text-xs text-gray-500">${p.symbol}</div>
                    </td>
                    <td class="px-3 py-2 text-center">${statusBadge}</td>
                    <td class="px-3 py-2 text-right font-mono text-xs">${p.remaining_qty || p.order_qty}</td>
                    <td class="px-3 py-2 text-right font-mono text-xs">${fmtPrice(p.order_price, exch)}</td>
                    <td class="px-3 py-2 text-gray-400 text-xs">${timeStr}</td>
                    <td class="px-3 py-2 text-gray-500 text-xs font-mono">${(p.order_no || '-').substring(0, 10)}</td>
                </tr>`;
            }).join('');
        } catch (e) { }
    }

    // Init
    refreshHoldings();
    refreshTrades();
    refreshPending();
    setInterval(refreshHoldings, 5000);
    setInterval(refreshTrades, 15000);
    setInterval(refreshPending, 10000);
</script>
{% endblock %}