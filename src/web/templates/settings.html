{% extends "layout.html" %}

{% block content %}
<div class="max-w-3xl mx-auto bg-gray-800 rounded p-6 border border-gray-700">
    <h2 class="text-xl font-bold text-white mb-6">âš™ï¸ Settings</h2>

    <div class="space-y-8">
        <!-- KIS API -->
        <div>
            <h3 class="text-md font-semibold text-blue-400 mb-3 flex items-center">
                <span class="mr-2">ğŸ¦</span> KIS API (í•œêµ­íˆ¬ìì¦ê¶Œ)
            </h3>
            <div class="space-y-2">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">App Key</label>
                    <input type="password" id="kis-app-key"
                        placeholder="{{ settings.KIS_APP_KEY.value if settings.KIS_APP_KEY.has_value else 'ë¯¸ì„¤ì •' }}"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">Secret Key</label>
                    <input type="password" id="kis-secret-key"
                        placeholder="{{ settings.KIS_SECRET_KEY.value if settings.KIS_SECRET_KEY.has_value else 'ë¯¸ì„¤ì •' }}"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1">ê³„ì¢Œë²ˆí˜¸</label>
                    <input type="password" id="kis-acct-stock"
                        placeholder="{{ settings.KIS_ACCT_STOCK.value if settings.KIS_ACCT_STOCK.has_value else 'ë¯¸ì„¤ì •' }}"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                </div>
            </div>
        </div>

        <!-- Antigravity Ultra -->
        <div class="pt-4 border-t border-gray-700">
            <h3 class="text-md font-semibold text-purple-400 mb-3 flex items-center">
                <span class="mr-2">ğŸš€</span> Antigravity Ultra
                <span id="ag-status-badge" class="ml-auto text-xs px-2 py-0.5 rounded-full bg-gray-600 text-gray-300">í™•ì¸
                    ì¤‘...</span>
            </h3>

            <!-- ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ -->
            <div id="ag-logged-out" class="hidden">
                <p class="text-sm text-gray-400 mb-3">
                    Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´ Claude Opus 4.5/4.6, Gemini 3 Pro ë“± ê³ ê¸‰ AI ëª¨ë¸ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <button onclick="antigravityLogin()" id="ag-login-btn"
                    class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-2.5 px-6 rounded-lg flex items-center justify-center space-x-2 transition-all">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" />
                        <path fill="currentColor"
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                        <path fill="currentColor"
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                        <path fill="currentColor"
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                    </svg>
                    <span>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</span>
                </button>
            </div>

            <div id="ag-logged-in" class="hidden space-y-3">
                <div class="flex items-center justify-between bg-gray-750 rounded-lg p-3"
                    style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div class="flex items-center space-x-2">
                        <span class="text-green-400 text-lg">ğŸŸ¢</span>
                        <div>
                            <div class="text-sm text-white font-medium" id="ag-email">-</div>
                            <div class="text-xs text-gray-400">Antigravity Ultra ì—°ê²°ë¨</div>
                        </div>
                    </div>
                    <button onclick="antigravityLogout()"
                        class="text-xs text-red-400 hover:text-red-300 px-3 py-1 rounded border border-red-800 hover:border-red-600 transition">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>

                <!-- ëª¨ë¸ ì„ íƒ -->
                <div>
                    <label class="text-xs text-gray-400 block mb-1">AI ëª¨ë¸</label>
                    <select id="ag-model-select" onchange="antigravitySetModel(this.value)"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                    </select>
                </div>
            </div>

            <!-- ë¡œê·¸ì¸ ì§„í–‰ ì¤‘ -->
            <div id="ag-logging-in" class="hidden text-center py-4">
                <div
                    class="animate-spin w-8 h-8 border-2 border-purple-400 border-t-transparent rounded-full mx-auto mb-2">
                </div>
                <p class="text-sm text-gray-400">Google ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘...</p>
                <p class="text-xs text-gray-500 mt-1">ë¸Œë¼ìš°ì €ì—ì„œ ë¡œê·¸ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”</p>
            </div>

            <!-- Legacy ì„¤ì • (ì ‘ê¸°) -->
            <details class="mt-3">
                <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-400">ê³ ê¸‰ ì„¤ì • (API Key / ëª¨ë¸)
                </summary>
                <div class="space-y-2 mt-2">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Google AI API Key</label>
                        <input type="password" id="antigravity-api-key"
                            placeholder="{{ settings.ANTIGRAVITY_API_KEY.value if settings.ANTIGRAVITY_API_KEY.has_value else 'ë¯¸ì„¤ì •' }}"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Model (Legacy)</label>
                        <select id="antigravity-model"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <option value="gemini-2.0-flash" {% if settings.ANTIGRAVITY_MODEL.value=='gemini-2.0-flash'
                                or not settings.ANTIGRAVITY_MODEL.has_value %}selected{% endif %}>gemini-2.0-flash
                            </option>
                            <option value="gemini-2.0-flash-lite" {% if
                                settings.ANTIGRAVITY_MODEL.value=='gemini-2.0-flash-lite' %}selected{% endif %}>
                                gemini-2.0-flash-lite</option>
                            <option value="gemini-1.5-pro" {% if settings.ANTIGRAVITY_MODEL.value=='gemini-1.5-pro'
                                %}selected{% endif %}>gemini-1.5-pro</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Google OAuth Client ID</label>
                        <input type="password" id="google-oauth-client-id"
                            placeholder="{{ settings.GOOGLE_OAUTH_CLIENT_ID.value if settings.GOOGLE_OAUTH_CLIENT_ID.has_value else 'ë¯¸ì„¤ì •' }}"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Google OAuth Client Secret</label>
                        <input type="password" id="google-oauth-secret"
                            placeholder="{{ settings.GOOGLE_OAUTH_CLIENT_SECRET.value if settings.GOOGLE_OAUTH_CLIENT_SECRET.has_value else 'ë¯¸ì„¤ì •' }}"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                    </div>
                </div>
            </details>
        </div>

        <!-- AI ì„¤ì • -->
        <div class="pt-4 border-t border-gray-700">
            <h3 class="text-md font-semibold text-yellow-400 mb-3 flex items-center">
                <span class="mr-2">ğŸ¤–</span> AI ì„¤ì •
            </h3>
            <div class="space-y-4">
                <div class="space-y-2">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">AI ëª¨ë“œ</label>
                        <select id="ai-mode"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <option value="local" {% if settings.AI_MODE.value=='local' or not
                                settings.AI_MODE.has_value %}selected{% endif %}>local (ë¡œì»¬ LLM ìš°ì„ )</option>
                            <option value="antigravity" {% if settings.AI_MODE.value=='antigravity' %}selected{% endif
                                %}>
                                antigravity (Google AI ì „ìš©)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Local LLM URL</label>
                        <input type="text" id="local-llm-url"
                            placeholder="{{ settings.LOCAL_LLM_URL.value or 'http://host.docker.internal:11434' }}"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Local LLM Model</label>
                        <input type="text" id="local-llm-model"
                            placeholder="{{ settings.LOCAL_LLM_MODEL.value or 'bitnet-3b' }}"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                    </div>
                </div>

                <!-- ë¡œì»¬ ëª¨ë¸ í•™ìŠµ -->
                <div class="bg-gray-750 p-3 rounded-lg border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-300 font-medium">ğŸ“ ë¡œì»¬ ëª¨ë¸ í•™ìŠµ (Fine-tuning)</span>
                        <span id="train-status-badge"
                            class="text-xs px-2 py-0.5 rounded-full bg-gray-600 text-gray-400">ëŒ€ê¸° ì¤‘</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-3">
                        ëˆ„ì ëœ ë§¤ë§¤ ê¸°ë¡(TrainingDataset)ì„ ì‚¬ìš©í•˜ì—¬ ë¡œì»¬ LLMì„ ë¯¸ì„¸ì¡°ì •í•©ë‹ˆë‹¤.
                        (GPU í•„ìš”, ì•½ 10~30ë¶„ ì†Œìš”)
                        <br>
                        <span id="dataset-status" class="mt-1 inline-block">ë°ì´í„° ì§‘ê³„ ì¤‘...</span>
                    </p>
                    <div class="flex items-center space-x-2">
                        <button onclick="startTraining()" id="btn-train-start"
                            class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1.5 px-4 rounded transition">
                            í•™ìŠµ ì‹œì‘
                        </button>
                        <span id="train-message" class="text-xs text-gray-400 truncate"></span>
                    </div>

                    <!-- ë°ì´í„°ì…‹ ê´€ë¦¬ -->
                    <div class="mt-4 pt-3 border-t border-gray-600 flex space-x-3">
                        <button onclick="exportDataset()"
                            class="bg-gray-600 hover:bg-gray-500 text-white text-xs py-1.5 px-3 rounded flex items-center space-x-1 transition">
                            <span>â¬‡ï¸</span><span>ë°ì´í„° ë‚´ë³´ë‚´ê¸° (JSONL)</span>
                        </button>
                        <label
                            class="bg-gray-600 hover:bg-gray-500 text-white text-xs py-1.5 px-3 rounded flex items-center space-x-1 cursor-pointer transition">
                            <span>â¬†ï¸</span><span>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</span>
                            <input type="file" id="dataset-upload" class="hidden" accept=".jsonl"
                                onchange="importDataset(this)">
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê±°ë˜ ì„¤ì • -->
        <div class="pt-4 border-t border-gray-700">
            <h3 class="text-md font-semibold text-orange-400 mb-3 flex items-center">
                <span class="mr-2">ğŸ“Š</span> ê±°ë˜ ì„¤ì •
            </h3>
            <div class="space-y-3">
                <!-- ìë™ ì¢…ëª© ìŠ¤ìº” -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="enable-auto-scan" class="rounded bg-gray-700 border-gray-600" {%
                                if settings.ENABLE_AUTO_SCAN.value !='0' %}checked{% endif %}>
                            <label for="enable-auto-scan" class="text-sm text-gray-300">ğŸ” ìë™ ì¢…ëª© ìŠ¤ìº”</label>
                        </div>
                        <p class="text-xs text-gray-500 ml-6">ì¥ ìš´ì˜ì‹œê°„ ì¤‘ ì¢…ëª©ì„ ìë™ìœ¼ë¡œ íƒìƒ‰í•˜ê³  AI ë¶„ì„í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <!-- ìë™ ë§¤ìˆ˜ ì‹¤í–‰ -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="enable-auto-buy" class="rounded bg-gray-700 border-gray-600" {%
                                if settings.ENABLE_AUTO_BUY.value=='1' %}checked{% endif %}>
                            <label for="enable-auto-buy" class="text-sm text-gray-300">ğŸ’° ìë™ ë§¤ìˆ˜ ì‹¤í–‰</label>
                        </div>
                        <p class="text-xs text-orange-500 ml-6">âš ï¸ í™œì„±í™” ì‹œ AI íŒë‹¨ì— ë”°ë¼ ì‹¤ì œ ë§¤ìˆ˜ ì£¼ë¬¸ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <!-- ìë™ ë§¤ë„ ì‹¤í–‰ -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="enable-auto-sell" class="rounded bg-gray-700 border-gray-600" {%
                                if settings.ENABLE_AUTO_SELL.value=='1' %}checked{% endif %}>
                            <label for="enable-auto-sell" class="text-sm text-gray-300">ğŸ“¤ ìë™ ë§¤ë„ ì‹¤í–‰</label>
                        </div>
                        <p class="text-xs text-orange-500 ml-6">âš ï¸ í™œì„±í™” ì‹œ AI íŒë‹¨ì— ë”°ë¼ ì‹¤ì œ ë§¤ë„ ì£¼ë¬¸ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <!-- ì¥ì™¸ ë¶„ì„ í™œë™ -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="enable-offmarket" class="rounded bg-gray-700 border-gray-600" {%
                                if settings.ENABLE_OFFMARKET.value !='0' %}checked{% endif %}>
                            <label for="enable-offmarket" class="text-sm text-gray-300">ğŸŒ™ ì¥ì™¸ ë¶„ì„ í™œë™</label>
                        </div>
                        <p class="text-xs text-gray-500 ml-6">ì¥ ë§ˆê° í›„ ì¼ë´‰ ìˆ˜ì§‘, ê¸°ìˆ ì  ë¶„ì„, ê¸€ë¡œë²Œ ì—°ë™ ë¶„ì„ ë“±ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <!-- ë‰´ìŠ¤/ê³µì‹œ ìˆ˜ì§‘ -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="enable-news-collect" class="rounded bg-gray-700 border-gray-600"
                                {% if settings.ENABLE_NEWS_COLLECT.value !='0' %}checked{% endif %}>
                            <label for="enable-news-collect" class="text-sm text-gray-300">ğŸ“° ë‰´ìŠ¤/ê³µì‹œ ìˆ˜ì§‘</label>
                        </div>
                        <p class="text-xs text-gray-500 ml-6">Yahoo Finance RSS ë‰´ìŠ¤ë¥¼ ìˆ˜ì§‘í•˜ê³  AI ê°ì„±ë¶„ì„ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <!-- ë ˆë²„ë¦¬ì§€/ì¸ë²„ìŠ¤ ê±°ë˜ í—ˆìš© -->
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="allow-leverage" class="rounded bg-gray-700 border-gray-600" {% if
                                settings.ALLOW_LEVERAGE.value=='1' %}checked{% endif %}>
                            <label for="allow-leverage" class="text-sm text-gray-300">âš¡ ë ˆë²„ë¦¬ì§€/ì¸ë²„ìŠ¤ ê±°ë˜ í—ˆìš©</label>
                        </div>
                        <p class="text-xs text-gray-500 ml-6">ë¹„í™œì„±í™” ì‹œ ë ˆë²„ë¦¬ì§€, ì¸ë²„ìŠ¤, ê³±ë²„ìŠ¤, 2X/3X ETF ë“±ì˜ ë§¤ìˆ˜ë¥¼ ì°¨ë‹¨í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>


        <!-- Discord -->
        <div class="pt-4 border-t border-gray-700">
            <h3 class="text-md font-semibold text-indigo-400 mb-3 flex items-center">
                <span class="mr-2">ğŸ’¬</span> Discord ì•Œë¦¼
            </h3>
            <div class="space-y-2">
                <div>
                    <label class="text-xs text-gray-400 block mb-1">Webhook URL</label>
                    <input type="text" id="discord-webhook"
                        placeholder="{{ settings.DISCORD_WEBHOOK_URL.value if settings.DISCORD_WEBHOOK_URL.has_value else 'https://discord.com/api/webhooks/...' }}"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                </div>

                <div class="flex items-center space-x-2 mt-2">
                    <input type="checkbox" id="noti-trade" class="rounded bg-gray-700 border-gray-600" {% if
                        settings.NOTI_TRADE_ALERTS.value !='0' %}checked{% endif %}>
                    <label for="noti-trade" class="text-sm text-gray-300">ë§¤ë§¤ ì•Œë¦¼ (Buy/Sell)</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="noti-report" class="rounded bg-gray-700 border-gray-600" {% if
                        settings.NOTI_HOURLY_REPORT.value !='0' %}checked{% endif %}>
                    <label for="noti-report" class="text-sm text-gray-300">ì‹œê°„ë³„ ë¦¬í¬íŠ¸</label>
                </div>

                <button onclick="testWebhook()" class="text-xs text-blue-400 hover:text-blue-300 underline mt-1">í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€
                    ì „ì†¡</button>
            </div>
        </div>

        <!-- ì €ì¥ + ì¬ì‹œì‘ ë²„íŠ¼ -->
        <div class="pt-6 border-t border-gray-700 flex items-center justify-between">
            <div id="save-status" class="text-sm text-gray-400"></div>
            <div class="flex items-center space-x-3">
                <button onclick="restartServer()"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded flex items-center space-x-2 transition">
                    <span>ğŸ”„</span><span>ì„œë²„ ì¬ì‹œì‘</span>
                </button>
                <button onclick="saveSettings()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-8 rounded transition">
                    ğŸ’¾ Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    async function saveSettings() {
        const statusEl = document.getElementById('save-status');
        statusEl.textContent = 'ì €ì¥ ì¤‘...';
        statusEl.className = 'text-sm text-yellow-400';

        const v = (id) => { const el = document.getElementById(id); return el ? el.value : null; };
        const c = (id) => { const el = document.getElementById(id); return el ? (el.checked ? '1' : '0') : '0'; };

        const data = {
            kis_app_key: v('kis-app-key') || null,
            kis_secret_key: v('kis-secret-key') || null,
            kis_acct_stock: v('kis-acct-stock') || null,
            antigravity_api_key: v('antigravity-api-key') || null,
            antigravity_model: v('antigravity-model') || null,
            google_oauth_client_id: v('google-oauth-client-id') || null,
            google_oauth_client_secret: v('google-oauth-secret') || null,
            discord_webhook_url: v('discord-webhook') || null,
            noti_trade_alerts: c('noti-trade'),
            noti_hourly_report: c('noti-report'),
            ai_mode: v('ai-mode') || null,
            local_llm_url: v('local-llm-url') || null,
            local_llm_model: v('local-llm-model') || null,
            allow_leverage: c('allow-leverage'),
            enable_auto_scan: c('enable-auto-scan'),
            enable_auto_buy: c('enable-auto-buy'),
            enable_auto_sell: c('enable-auto-sell'),
            enable_offmarket: c('enable-offmarket'),
            enable_news_collect: c('enable-news-collect'),
        };

        try {
            const res = await fetch('/api/settings/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const result = await res.json();
                statusEl.textContent = `âœ… ${result.saved}ê°œ ì„¤ì • ì €ì¥ ì™„ë£Œ`;
                statusEl.className = 'text-sm text-green-400';
                // 2ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ë§ˆìŠ¤í‚¹ëœ ê°’ ë°˜ì˜)
                setTimeout(() => location.reload(), 2000);
            } else {
                statusEl.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
                statusEl.className = 'text-sm text-red-400';
            }
        } catch (e) {
            console.error(e);
            statusEl.textContent = 'âŒ ì—°ê²° ì˜¤ë¥˜';
            statusEl.className = 'text-sm text-red-400';
        }
    }

    async function testWebhook() {
        const webhook = document.getElementById('discord-webhook').value;
        if (!webhook) return alert('Webhook URLì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');

        try {
            const res = await fetch('/api/settings/test-webhook', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: webhook })
            });
            const result = await res.json();
            alert(result.message || 'í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ!');
        } catch (e) {
            alert('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
        }
    }

    async function restartServer() {
        if (!confirm('ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì„¤ì • ë³€ê²½ì‚¬í•­ì´ ì ìš©ë©ë‹ˆë‹¤.')) return;

        const statusEl = document.getElementById('save-status');
        statusEl.textContent = 'ğŸ”„ ì„œë²„ ì¬ì‹œì‘ ì¤‘...';
        statusEl.className = 'text-sm text-yellow-400';

        try {
            await fetch('/api/server/restart', { method: 'POST' });
        } catch (e) {
            // ì„œë²„ ì¢…ë£Œë¡œ ì—°ê²°ì´ ëŠì–´ì§€ë©´ ì •ìƒ
        }

        // ì¬ì‹œì‘ ëŒ€ê¸° í›„ ìë™ ìƒˆë¡œê³ ì¹¨
        statusEl.textContent = 'â³ 3ì´ˆ í›„ ìë™ ìƒˆë¡œê³ ì¹¨...';
        let countdown = 3;
        const interval = setInterval(() => {
            countdown--;
            statusEl.textContent = `â³ ${countdown}ì´ˆ í›„ ìë™ ìƒˆë¡œê³ ì¹¨...`;
            if (countdown <= 0) {
                clearInterval(interval);
                location.reload();
            }
        }, 1000);
    }

    // ============================
    // Antigravity Ultra Auth
    // ============================

    let _agPollTimer = null;

    async function loadAntigravityStatus() {
        try {
            const res = await fetch('/api/antigravity/status');
            const data = await res.json();
            const badge = document.getElementById('ag-status-badge');
            const loggedOut = document.getElementById('ag-logged-out');
            const loggedIn = document.getElementById('ag-logged-in');
            const loggingIn = document.getElementById('ag-logging-in');

            loggingIn.classList.add('hidden');

            if (data.authenticated) {
                loggedOut.classList.add('hidden');
                loggedIn.classList.remove('hidden');
                document.getElementById('ag-email').textContent = data.email || 'Unknown';
                badge.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
                badge.className = 'ml-auto text-xs px-2 py-0.5 rounded-full bg-green-900 text-green-300';

                // ëª¨ë¸ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
                const select = document.getElementById('ag-model-select');
                select.innerHTML = '';
                for (const [value, label] of Object.entries(data.available_models || {})) {
                    const opt = document.createElement('option');
                    opt.value = value;
                    opt.textContent = label;
                    if (value === data.model) opt.selected = true;
                    select.appendChild(opt);
                }
            } else {
                loggedOut.classList.remove('hidden');
                loggedIn.classList.add('hidden');
                badge.textContent = 'ğŸ”´ ë¯¸ì—°ê²°';
                badge.className = 'ml-auto text-xs px-2 py-0.5 rounded-full bg-red-900 text-red-300';
            }
        } catch (e) {
            console.error('Failed to load Antigravity status:', e);
        }
    }

    async function antigravityLogin() {
        const loggedOut = document.getElementById('ag-logged-out');
        const loggingIn = document.getElementById('ag-logging-in');

        loggedOut.classList.add('hidden');
        loggingIn.classList.remove('hidden');

        try {
            const res = await fetch('/api/antigravity/login', { method: 'POST' });
            const data = await res.json();

            if (data.status !== 'login_started') {
                alert('ë¡œê·¸ì¸ ì‹œì‘ ì‹¤íŒ¨: ' + (data.error || 'Unknown error'));
                loggedOut.classList.remove('hidden');
                loggingIn.classList.add('hidden');
                return;
            }

            // í´ë¼ì´ì–¸íŠ¸ ë¸Œë¼ìš°ì €ì—ì„œ Google ë¡œê·¸ì¸ í˜ì´ì§€ ì—´ê¸°
            window.open(data.auth_url, '_blank');

            // ì½œë°± ì™„ë£Œ í´ë§
            _agPollTimer = setInterval(async () => {
                try {
                    const pollRes = await fetch('/api/antigravity/callback-status');
                    const pollData = await pollRes.json();
                    if (pollData.completed) {
                        clearInterval(_agPollTimer);
                        _agPollTimer = null;
                        if (pollData.success) {
                            loadAntigravityStatus();
                        } else {
                            alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (pollData.error || 'Unknown error'));
                            loggedOut.classList.remove('hidden');
                            loggingIn.classList.add('hidden');
                        }
                    }
                } catch (e) {
                    console.error('Poll error:', e);
                }
            }, 1500);

            // 5ë¶„ íƒ€ì„ì•„ì›ƒ
            setTimeout(() => {
                if (_agPollTimer) {
                    clearInterval(_agPollTimer);
                    _agPollTimer = null;
                    loggedOut.classList.remove('hidden');
                    loggingIn.classList.add('hidden');
                    alert('ë¡œê·¸ì¸ ì‹œê°„ ì´ˆê³¼');
                }
            }, 300000);

        } catch (e) {
            alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + e.message);
            loggedOut.classList.remove('hidden');
            loggingIn.classList.add('hidden');
        }
    }

    async function antigravityLogout() {
        if (!confirm('Antigravity Ultraì—ì„œ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            await fetch('/api/antigravity/logout', { method: 'POST' });
            loadAntigravityStatus();
        } catch (e) {
            alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨');
        }
    }

    async function antigravitySetModel(model) {
        try {
            const res = await fetch('/api/antigravity/model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model })
            });
            if (res.ok) {
                const badge = document.getElementById('ag-status-badge');
                badge.textContent = 'âœ… ëª¨ë¸ ë³€ê²½ë¨';
                setTimeout(() => { badge.textContent = 'ğŸŸ¢ ì—°ê²°ë¨'; }, 2000);
            }
        } catch (e) {
            alert('ëª¨ë¸ ë³€ê²½ ì‹¤íŒ¨');
        }
    }

    // ============================
    // ë¡œì»¬ ëª¨ë¸ í•™ìŠµ
    // ============================

    async function loadTrainingStatus() {
        try {
            // í•™ìŠµ ìƒíƒœ ì¡°íšŒ
            const resStatus = await fetch('/api/ai/train/status');
            const dataStatus = await resStatus.json();
            updateTrainingUI(dataStatus);

            // ë°ì´í„°ì…‹ ê°œìˆ˜ ì¡°íšŒ
            const resCount = await fetch('/api/ai/dataset/count');
            const dataCount = await resCount.json();
            updateDatasetUI(dataCount);
        } catch (e) {
            console.error('Training status error:', e);
        }
    }

    function updateDatasetUI(data) {
        const el = document.getElementById('dataset-status');
        const total = data.total;
        const recommended = data.recommended;

        let color = 'text-green-400';
        let icon = 'âœ…';
        let msg = 'í•™ìŠµ ê°€ëŠ¥';

        if (total < recommended) {
            color = 'text-red-400';
            icon = 'âš ï¸';
            msg = `ë°ì´í„° ë¶€ì¡± (ìµœì†Œ ${recommended}ê±´ ê¶Œì¥)`;
        } else if (total < recommended * 2) {
            color = 'text-yellow-400';
            icon = 'ğŸ“Š';
            msg = 'í•™ìŠµ ê°€ëŠ¥ (ë°ì´í„° ì¶”ê°€ ê¶Œì¥)';
        }

        el.className = `mt-1 inline-block font-medium ${color}`;
        el.textContent = `${icon} í˜„ì¬ ë°ì´í„°ì…‹: ${total}ê±´ (${msg})`;
    }

    function updateTrainingUI(data) {
        const badge = document.getElementById('train-status-badge');
        const btn = document.getElementById('btn-train-start');
        const msg = document.getElementById('train-message');

        msg.textContent = data.message || "";

        if (data.status === 'running') {
            badge.textContent = 'í•™ìŠµ ì¤‘...';
            badge.className = 'text-xs px-2 py-0.5 rounded-full bg-yellow-900 text-yellow-300 animate-pulse';
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.textContent = 'ì§„í–‰ ì¤‘';
        } else if (data.status === 'completed') {
            badge.textContent = 'ì™„ë£Œë¨';
            badge.className = 'text-xs px-2 py-0.5 rounded-full bg-green-900 text-green-300';
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.textContent = 'ë‹¤ì‹œ í•™ìŠµ';
        } else if (data.status === 'error') {
            badge.textContent = 'ì˜¤ë¥˜';
            badge.className = 'text-xs px-2 py-0.5 rounded-full bg-red-900 text-red-300';
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.textContent = 'ë‹¤ì‹œ ì‹œë„';
        } else {
            badge.textContent = 'ëŒ€ê¸° ì¤‘';
            badge.className = 'text-xs px-2 py-0.5 rounded-full bg-gray-600 text-gray-400';
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.textContent = 'í•™ìŠµ ì‹œì‘';
        }
    }

    async function startTraining() {
        if (!confirm('ë¡œì»¬ ëª¨ë¸ í•™ìŠµì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nGPU ìì›ì´ ë§ì´ ì†Œëª¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;

        try {
            const res = await fetch('/api/ai/train/start', { method: 'POST' });
            const data = await res.json();

            if (res.ok) {
                alert('í•™ìŠµ í”„ë¡œì„¸ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\nì™„ë£Œ ì‹œ ì‹œìŠ¤í…œ ë¡œê·¸ì— ê¸°ë¡ë©ë‹ˆë‹¤.');
                loadTrainingStatus();
            } else {
                alert('ì˜¤ë¥˜: ' + data.error);
            }
        } catch (e) {
            alert('ìš”ì²­ ì‹¤íŒ¨: ' + e.message);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ í™•ì¸
    document.addEventListener('DOMContentLoaded', () => {
        loadAntigravityStatus();
        loadTrainingStatus();
        // 5ì´ˆë§ˆë‹¤ í•™ìŠµ ìƒíƒœ í´ë§
        setInterval(loadTrainingStatus, 5000);
    });

</script>
{% endblock %}