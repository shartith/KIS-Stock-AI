{% extends "layout.html" %}

{% block content %}
<div class="dash-grid">
    <!-- â”€â”€ Row 1: Market Indices Bar â”€â”€ -->
    <div class="indices-bar bg-gray-800 rounded-lg p-3 border border-gray-700">
        <div class="indices-row" id="market-indices">
            <div class="animate-pulse bg-gray-700 h-10 rounded flex-1"></div>
        </div>
    </div>

    <!-- â”€â”€ Row 2: Country Tabs + Heatmap â”€â”€ -->
    <div class="heatmap-section bg-gray-800 rounded-lg border border-gray-700 flex flex-col">
        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-btn active" data-country="KR">
                <span class="tab-flag">ğŸ‡°ğŸ‡·</span>
                <span class="tab-label">í•œêµ­</span>
                <span class="tab-hours">09:00~15:30</span>
                <span class="tab-status" id="status-KR"></span>
            </button>
            <button class="tab-btn" data-country="JP">
                <span class="tab-flag">ğŸ‡¯ğŸ‡µ</span>
                <span class="tab-label">ì¼ë³¸</span>
                <span class="tab-hours">09:00~15:00</span>
                <span class="tab-status" id="status-JP"></span>
            </button>
            <button class="tab-btn" data-country="CN">
                <span class="tab-flag">ğŸ‡¨ğŸ‡³</span>
                <span class="tab-label">ì¤‘êµ­</span>
                <span class="tab-hours">10:00~16:00</span>
                <span class="tab-status" id="status-CN"></span>
            </button>
            <button class="tab-btn" data-country="HK">
                <span class="tab-flag">ğŸ‡­ğŸ‡°</span>
                <span class="tab-label">í™ì½©</span>
                <span class="tab-hours">10:00~17:00</span>
                <span class="tab-status" id="status-HK"></span>
            </button>
            <button class="tab-btn" data-country="US">
                <span class="tab-flag">ğŸ‡ºğŸ‡¸</span>
                <span class="tab-label">ë¯¸êµ­</span>
                <span class="tab-hours">23:30~06:00</span>
                <span class="tab-status" id="status-US"></span>
            </button>
        </div>
        <!-- Treemap Area -->
        <div class="heatmap-treemap" id="heatmap-grid">
            <div class="heatmap-loading" id="heatmap-loading">
                <div class="loading-spinner"></div>
                Loading market data...
            </div>
        </div>
    </div>

    <!-- â”€â”€ Row 3: AI Logs & Candidates â”€â”€ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 h-48 md:h-64">
        <!-- AI Logs -->
        <div class="bg-gray-800 rounded-lg p-3 border border-gray-700 flex flex-col">
            <h2 class="text-xs font-semibold text-gray-500 mb-2 uppercase">AI Trader Live Logs</h2>
            <div class="flex-1 overflow-y-auto font-mono text-xs space-y-1 bg-gray-900 p-2 rounded border border-gray-700"
                id="ai-logs">
                <div class="text-gray-500">Connecting to AI Monitor...</div>
            </div>
        </div>

        <!-- AI Candidates (New) -->
        <div class="bg-gray-800 rounded-lg p-3 border border-gray-700 flex flex-col">
            <h2 class="text-xs font-semibold text-gray-500 mb-2 uppercase flex justify-between">
                <span>ğŸ¯ Top Candidates</span>
                <span class="text-blue-400 cursor-pointer hover:underline" onclick="refreshCandidates()">Refresh</span>
            </h2>
            <div class="flex-1 overflow-y-auto space-y-2" id="candidates-list">
                <!-- JSë¡œ ì±„ì›€ -->
                <div class="text-center text-gray-500 text-xs py-10">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>
</div>

<!-- AI Reasoning Modal -->
<div id="reasoning-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg border border-gray-600 w-full max-w-2xl mx-4 shadow-2xl">
        <div class="flex justify-between items-center p-4 border-b border-gray-700">
            <h3 class="text-lg font-bold text-white" id="modal-title">AI ë¶„ì„ ìƒì„¸</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[70vh]">
            <div class="space-y-4">
                <div>
                    <div class="text-xs text-gray-500 mb-1">ì¢…ëª©</div>
                    <div class="text-xl font-bold text-white" id="modal-stock"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-xs text-gray-500 mb-1">AI íŒë‹¨ / ì ìˆ˜</div>
                        <div class="text-white"><span id="modal-action" class="font-bold"></span> (<span id="modal-score"></span>ì )</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 mb-1">ë¶„ì„ ì‹œê°</div>
                        <div class="text-white" id="modal-time"></div>
                    </div>
                </div>
                <div>
                    <div class="text-xs text-gray-500 mb-1">ë‰´ìŠ¤ ìš”ì•½</div>
                    <div class="text-sm text-gray-300 bg-gray-900 p-3 rounded" id="modal-news"></div>
                </div>
                <div>
                    <div class="text-xs text-gray-500 mb-1">AI ì‚¬ê³  ê³¼ì • (Chain of Thought)</div>
                    <div class="text-sm text-gray-300 bg-gray-900 p-3 rounded whitespace-pre-wrap leading-relaxed" id="modal-reasoning"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* â”€â”€ Dashboard Grid â”€â”€ */
    .dash-grid {
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 12px;
        height: calc(100vh - 90px);
        min-height: 600px;
    }

    /* â”€â”€ Indices Bar â”€â”€ */
    .indices-bar {
        overflow-x: auto;
    }

    .indices-row {
        display: flex;
        gap: 8px;
        min-width: max-content;
    }

    .idx-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #374151;
        border-radius: 6px;
        padding: 6px 14px;
        min-width: 140px;
        gap: 12px;
    }

    .idx-name {
        font-weight: 700;
        font-size: 12px;
        color: #d1d5db;
        white-space: nowrap;
    }

    .idx-val {
        font-weight: 700;
        font-size: 14px;
        color: #fff;
    }

    .idx-chg {
        font-size: 11px;
        font-weight: 600;
    }

    .idx-up {
        color: #f87171;
    }

    .idx-dn {
        color: #60a5fa;
    }

    /* â”€â”€ Tab Bar â”€â”€ */
    .tab-bar {
        display: flex;
        border-bottom: 1px solid #374151;
        padding: 0 4px;
        background: #1e2736;
        border-radius: 8px 8px 0 0;
        overflow-x: auto;
    }

    .tab-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        border: none;
        background: transparent;
        color: #9ca3af;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .tab-btn:hover {
        color: #e5e7eb;
        background: rgba(255, 255, 255, 0.04);
    }

    .tab-btn.active {
        color: #fff;
        border-bottom-color: #3b82f6;
        background: rgba(59, 130, 246, 0.08);
    }

    .tab-flag {
        font-size: 18px;
    }

    .tab-label {
        font-weight: 700;
    }

    .tab-hours {
        font-size: 10px;
        color: #6b7280;
    }

    .tab-status {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: #6b7280;
    }

    .tab-status.open {
        background: #22c55e;
        animation: pulse 2s infinite;
    }

    .tab-status.closed {
        background: #6b7280;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.4;
        }
    }

    /* â”€â”€ Heatmap Treemap â”€â”€ */
    .heatmap-section {
        min-height: 0;
        overflow: hidden;
    }

    .heatmap-treemap {
        flex: 1;
        position: relative;
        min-height: 300px;
        overflow: hidden;
    }

    .heatmap-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #9ca3af;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .loading-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #4b5563;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .treemap-cell {
        position: absolute;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: filter 0.15s;
        border: 1px solid rgba(0, 0, 0, 0.35);
        box-sizing: border-box;
    }

    .treemap-cell:hover {
        filter: brightness(1.25);
        z-index: 10;
    }

    .treemap-cell .cell-name {
        font-weight: 700;
        color: #fff;
        text-align: center;
        line-height: 1.15;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 96%;
    }

    .treemap-cell .cell-price {
        color: rgba(255, 255, 255, 0.75);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    }

    .treemap-cell .cell-change {
        font-weight: 700;
        color: #fff;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* Color gradient â€” 8 levels */
    .hm-up-3 {
        background: #dc2626;
    }

    .hm-up-2 {
        background: #b91c1c;
    }

    .hm-up-1 {
        background: #991b1b;
    }

    .hm-up-0 {
        background: #7f1d1d;
    }

    .hm-dn-0 {
        background: #1e3a5f;
    }

    .hm-dn-1 {
        background: #1e40af;
    }

    .hm-dn-2 {
        background: #1d4ed8;
    }

    .hm-dn-3 {
        background: #2563eb;
    }

    .hm-flat {
        background: #374151;
    }

    /* â”€â”€ Logs â”€â”€ */
    .logs-section {
        flex-shrink: 0;
        min-height: 200px;
        max-height: 200px;
        display: flex;
        flex-direction: column;
    }
    
    #ai-logs {
        overflow-y: auto;
        flex: 1;
        min-height: 0; /* ì¤‘ìš”: flex ìì‹ì˜ overflow ë™ì‘ì„ ìœ„í•¨ */
    }

    /* â”€â”€ Candidates List â”€â”€ */
    #candidates-list {
        overflow-y: auto;
        max-height: 200px; /* ëª…ì‹œì  ë†’ì´ ì œí•œ */
        min-height: 0;
    }
    
    /* â”€â”€ Scrollbar â”€â”€ */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    ::-webkit-scrollbar-track {
        background: #1f2937;
    }
    ::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
    }

    @media (max-width: 768px) {
        .dash-grid {
            height: auto;
        }

        .tab-btn {
            padding: 8px 10px;
            font-size: 12px;
        }

        .tab-hours {
            display: none;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // =============================================
    // State
    // =============================================
    let currentCountry = 'KR';
    const stocksCache = {};  // country -> { data, ts }

    // =============================================
    // Squarified Treemap
    // =============================================
    function squarify(items, rect) {
        if (!items.length) return [];
        const totalArea = rect.w * rect.h;
        const totalValue = items.reduce((s, i) => s + i.value, 0);
        if (totalValue <= 0) return [];
        const normalized = items.map(i => ({
            ...i, area: (i.value / totalValue) * totalArea
        }));
        const result = [];
        layoutRow(normalized, rect, result);
        return result;
    }

    function layoutRow(items, rect, result) {
        if (!items.length) return;
        if (items.length === 1) {
            result.push({ ...items[0], x: rect.x, y: rect.y, w: rect.w, h: rect.h });
            return;
        }
        const shorter = Math.min(rect.w, rect.h);
        const horizontal = rect.w >= rect.h;
        let row = [items[0]];
        let bestRatio = worstRatio(row, shorter);
        for (let i = 1; i < items.length; i++) {
            const testRow = [...row, items[i]];
            const ratio = worstRatio(testRow, shorter);
            if (ratio <= bestRatio) {
                row = testRow;
                bestRatio = ratio;
            } else break;
        }
        const remaining = items.slice(row.length);
        const rowArea = row.reduce((s, i) => s + i.area, 0);
        if (horizontal) {
            const rowLen = rowArea / rect.h;
            let cy = rect.y;
            for (const item of row) {
                const itemH = item.area / rowLen;
                result.push({ ...item, x: rect.x, y: cy, w: rowLen, h: itemH });
                cy += itemH;
            }
            layoutRow(remaining, { x: rect.x + rowLen, y: rect.y, w: rect.w - rowLen, h: rect.h }, result);
        } else {
            const rowLen = rowArea / rect.w;
            let cx = rect.x;
            for (const item of row) {
                const itemW = item.area / rowLen;
                result.push({ ...item, x: cx, y: rect.y, w: itemW, h: rowLen });
                cx += itemW;
            }
            layoutRow(remaining, { x: rect.x, y: rect.y + rowLen, w: rect.w, h: rect.h - rowLen }, result);
        }
    }

    function worstRatio(row, side) {
        const totalArea = row.reduce((s, i) => s + i.area, 0);
        const rowLen = totalArea / side;
        let worst = 0;
        for (const { area } of row) {
            const long = Math.max(rowLen, area / rowLen);
            const short = Math.min(rowLen, area / rowLen);
            worst = Math.max(worst, long / short);
        }
        return worst;
    }

    // =============================================
    // Color & Size
    // =============================================
    function getHeatmapClass(change) {
        if (change >= 3) return 'hm-up-3';
        if (change >= 2) return 'hm-up-2';
        if (change >= 1) return 'hm-up-1';
        if (change > 0.05) return 'hm-up-0';
        if (change <= -3) return 'hm-dn-3';
        if (change <= -2) return 'hm-dn-2';
        if (change <= -1) return 'hm-dn-1';
        if (change < -0.05) return 'hm-dn-0';
        return 'hm-flat';
    }

    function getFontSizes(area, totalArea) {
        const r = area / totalArea;
        if (r > 0.08) return { name: 15, price: 12, change: 14 };
        if (r > 0.04) return { name: 13, price: 10, change: 12 };
        if (r > 0.02) return { name: 11, price: 9, change: 10 };
        if (r > 0.01) return { name: 10, price: 0, change: 9 };
        return { name: 8, price: 0, change: 7 };
    }

    // =============================================
    // Market Status (ê°œì¥/íì¥)
    // =============================================
    function updateMarketStatus() {
        const now = new Date();
        const utcH = now.getUTCHours(), utcM = now.getUTCMinutes();
        const utcMin = utcH * 60 + utcM;
        // í•œêµ­(+9) 09:00~15:30 â†’ UTC 00:00~06:30
        setStatus('KR', utcMin >= 0 && utcMin < 390);
        // ì¼ë³¸(+9) 09:00~15:00 â†’ UTC 00:00~06:00
        setStatus('JP', utcMin >= 0 && utcMin < 360);
        // ì¤‘êµ­(+8) 10:00~16:00 â†’ UTC 02:00~08:00
        setStatus('CN', utcMin >= 120 && utcMin < 480);
        // í™ì½©(+8) 10:00~17:00 â†’ UTC 02:00~09:00
        setStatus('HK', utcMin >= 120 && utcMin < 540);
        // ë¯¸êµ­(EST, -5) 09:30~16:00 â†’ UTC 14:30~21:00
        setStatus('US', utcMin >= 870 && utcMin < 1260);
    }
    function setStatus(country, isOpen) {
        const el = document.getElementById('status-' + country);
        if (el) {
            el.className = 'tab-status ' + (isOpen ? 'open' : 'closed');
        }
    }

    // =============================================
    // Tab Handling
    // =============================================
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentCountry = btn.dataset.country;
            renderHeatmap(currentCountry);
        });
    });

    // =============================================
    // Data Fetching
    // =============================================
    async function fetchStocks(country) {
        const now = Date.now();
        if (stocksCache[country] && (now - stocksCache[country].ts) < 60000) {
            return stocksCache[country].data;
        }
        const res = await fetch(`/api/stocks/top?country=${country}`);
        const data = await res.json();
        stocksCache[country] = { data, ts: now };
        return data;
    }

    // =============================================
    // Render Treemap
    // =============================================
    async function renderHeatmap(country) {
        const container = document.getElementById('heatmap-grid');
        const loading = document.getElementById('heatmap-loading');

        // Show loading
        container.innerHTML = `<div class="heatmap-loading" id="heatmap-loading">
            <div class="loading-spinner"></div> Loading ${country} market data...</div>`;

        const stocks = await fetchStocks(country);

        if (!stocks.length) {
            container.innerHTML = '<div class="heatmap-loading">No data available</div>';
            return;
        }

        const rect = container.getBoundingClientRect();
        const width = rect.width || 800;
        const height = rect.height || 450;

        stocks.sort((a, b) => (b.market_cap || 10) - (a.market_cap || 10));

        const treemapItems = stocks.map(s => ({ ...s, value: s.market_cap || 10 }));
        const cells = squarify(treemapItems, { x: 0, y: 0, w: width, h: height });
        const totalArea = width * height;

        let html = '';
        for (const cell of cells) {
            const colorClass = getHeatmapClass(cell.change);
            const fonts = getFontSizes(cell.w * cell.h, totalArea);
            const changeStr = cell.change > 0 ? `+${cell.change}%` : `${cell.change}%`;
            const priceStr = typeof cell.price === 'number'
                ? cell.price.toLocaleString() : cell.price;

            let content = `<span class="cell-name" style="font-size:${fonts.name}px">${cell.name}</span>`;
            if (fonts.price > 0 && cell.w > 55 && cell.h > 40) {
                content += `<span class="cell-price" style="font-size:${fonts.price}px">${priceStr}</span>`;
            }
            if (cell.h > 28) {
                content += `<span class="cell-change" style="font-size:${fonts.change}px">${changeStr}</span>`;
            }

            html += `<div class="treemap-cell ${colorClass}" 
                style="left:${cell.x}px;top:${cell.y}px;width:${cell.w}px;height:${cell.h}px;"
                title="${cell.name} (${cell.code})\n${priceStr}\n${changeStr}\n~${cell.market_cap || '?'}">
                ${content}</div>`;
        }
        container.innerHTML = html;
    }

    // =============================================
    // Update Indices
    // =============================================
    async function updateIndices() {
        try {
            const res = await fetch('/api/market/indices');
            const indices = await res.json();
            const html = Object.keys(indices).map(key => {
                const item = indices[key];
                const chgClass = item.change > 0 ? 'idx-up' : 'idx-dn';
                const arrow = item.change > 0 ? 'â–²' : (item.change < 0 ? 'â–¼' : '');
                return `<div class="idx-card">
                    <span class="idx-name">${key}</span>
                    <div style="text-align:right">
                        <div class="idx-val">${item.value}</div>
                        <div class="idx-chg ${chgClass}">${arrow} ${item.change > 0 ? '+' : ''}${item.change}%</div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('market-indices').innerHTML = html;
        } catch (e) { console.error('Indices error', e); }
    }

    // =============================================
    // Init
    // =============================================
    async function init() {
        updateMarketStatus();
        await updateIndices();
        await renderHeatmap(currentCountry);
    }

    init();
    setInterval(() => {
        updateMarketStatus();
        updateIndices();
        renderHeatmap(currentCountry);
    }, 15000);

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => renderHeatmap(currentCountry), 300);
    });
    // =============================================
    // AI Log SSE Stream
    // =============================================
    const LOG_COLORS = {
        SYSTEM: 'text-green-400',
        INFO: 'text-gray-400',
        SCAN: 'text-cyan-400',
        BULL: 'text-red-400',
        BEAR: 'text-blue-400',
        ALERT: 'text-orange-400',
        TOKEN: 'text-yellow-400',
        WARN: 'text-yellow-500',
        ERROR: 'text-red-500',
    };

    function connectLogStream() {
        const logEl = document.getElementById('ai-logs');
        const evtSrc = new EventSource('/api/logs/stream');
        let firstMessage = true;

        evtSrc.onmessage = (event) => {
            try {
                const entry = JSON.parse(event.data);
                if (entry.level === 'ping') return; // keep-alive
                if (firstMessage) { logEl.innerHTML = ''; firstMessage = false; }

                const colorClass = LOG_COLORS[entry.level] || 'text-gray-400';
                const div = document.createElement('div');
                div.className = colorClass;
                div.textContent = `[${entry.time}] [${entry.level}] ${entry.message}`;
                logEl.appendChild(div);

                // ìµœëŒ€ 200ì¤„ ìœ ì§€
                while (logEl.children.length > 200) logEl.removeChild(logEl.firstChild);
                logEl.scrollTop = logEl.scrollHeight;
            } catch (e) { }
        };

        evtSrc.onerror = () => {
            evtSrc.close();
            const div = document.createElement('div');
            div.className = 'text-yellow-500';
            div.textContent = `[${new Date().toLocaleTimeString()}] [WARN] ì—°ê²° ëŠê¹€ â€” ì¬ì—°ê²° ì¤‘...`;
            logEl.appendChild(div);
            setTimeout(connectLogStream, 3000);
        };
    }
    connectLogStream();

    // =============================================
    // Candidates & Modal
    // =============================================
    let candidatesData = [];

    async function refreshCandidates() {
        const listEl = document.getElementById('candidates-list');
        listEl.innerHTML = '<div class="text-center text-gray-500 text-xs py-10">ìƒˆë¡œê³ ì¹¨ ì¤‘...</div>';
        
        try {
            const res = await fetch('/api/scanner/results?limit=50');
            const data = await res.json();
            candidatesData = data.results || [];
            
            // BUYì´ë©´ì„œ ì ìˆ˜ê°€ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
            const buys = candidatesData.filter(c => c.ai_action === 'BUY').sort((a, b) => b.ai_score - a.ai_score);
            const others = candidatesData.filter(c => c.ai_action !== 'BUY');
            const displayList = [...buys, ...others];

            if (displayList.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-500 text-xs py-10">ë¶„ì„ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            listEl.innerHTML = displayList.map((c, idx) => {
                const isBuy = c.ai_action === 'BUY';
                const scoreColor = c.ai_score >= 80 ? 'text-red-400' : (c.ai_score >= 50 ? 'text-yellow-400' : 'text-gray-400');
                const actionClass = isBuy ? 'bg-red-900 text-red-300' : 'bg-gray-700 text-gray-400';
                
                return `
                <div class="flex items-center justify-between bg-gray-750 p-2 rounded hover:bg-gray-700 transition cursor-pointer border border-transparent hover:border-gray-600"
                    onclick="openModal(${idx})">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold w-8 ${actionClass} px-1.5 py-0.5 rounded text-center">${c.ai_action}</span>
                        <div>
                            <div class="text-sm font-bold text-gray-200">${c.name} <span class="text-xs text-gray-500 font-normal">(${c.symbol})</span></div>
                            <div class="text-xs text-gray-500">${c.market} â€¢ ${c.analyzed_at}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold ${scoreColor}">${c.ai_score}ì </div>
                        <div class="text-xs text-gray-500">ì‹ ë¢°ë„ ${c.ai_confidence}%</div>
                    </div>
                </div>`;
            }).join('');
            
        } catch (e) {
            console.error(e);
            listEl.innerHTML = '<div class="text-center text-red-500 text-xs py-10">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
        }
    }

    // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ (onclick ìš©)
    window.openModal = function(idx) {
        // ì¸ë±ìŠ¤ê°€ ì•„ë‹Œ ì‹¤ì œ ë°ì´í„° ê°ì²´ë¥¼ ì°¾ì•„ì•¼ í•¨ (ìœ„ì—ì„œ ì •ë ¬í–ˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ ì •ë ¬)
        const buys = candidatesData.filter(c => c.ai_action === 'BUY').sort((a, b) => b.ai_score - a.ai_score);
        const others = candidatesData.filter(c => c.ai_action !== 'BUY');
        const displayList = [...buys, ...others];
        
        const c = displayList[idx];
        if (!c) return;

        document.getElementById('modal-stock').textContent = `${c.name} (${c.symbol})`;
        document.getElementById('modal-action').textContent = c.ai_action;
        document.getElementById('modal-action').className = c.ai_action === 'BUY' ? 'font-bold text-red-400' : 'font-bold text-gray-400';
        document.getElementById('modal-score').textContent = c.ai_score;
        document.getElementById('modal-time').textContent = c.analyzed_at;
        
        // ë‰´ìŠ¤ í‘œì‹œ (ì—†ìœ¼ë©´ ë©”ì‹œì§€)
        const news = c.news_count > 0 ? `${c.news_count}ê±´ì˜ ìµœì‹  ë‰´ìŠ¤ ë°˜ì˜ë¨` : 'ê´€ë ¨ ë‰´ìŠ¤ ì—†ìŒ';
        document.getElementById('modal-news').textContent = news; // ìƒì„¸ ë‰´ìŠ¤ ë‚´ìš©ì€ í˜„ì¬ API ì‘ë‹µì— í¬í•¨ë˜ì§€ ì•ŠìŒ (í•„ìš”ì‹œ ì¶”ê°€)

        // Reasoning (ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
        let reasoning = c.ai_reason_detail || c.ai_reason || "ìƒì„¸ ë¶„ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
        // ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ ì œê±° ë“± í¬ë§·íŒ…
        reasoning = reasoning.replace(/\*\*/g, '').replace(/###/g, '').trim();
        document.getElementById('modal-reasoning').textContent = reasoning;

        document.getElementById('reasoning-modal').classList.remove('hidden');
    };

    window.closeModal = function() {
        document.getElementById('reasoning-modal').classList.add('hidden');
    };

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('reasoning-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('reasoning-modal')) closeModal();
    });
    
    // ì´ˆê¸° ë¡œë“œ ë° ì£¼ê¸°ì  ê°±ì‹ 
    refreshCandidates();
    setInterval(refreshCandidates, 30000); // 30ì´ˆë§ˆë‹¤ ê°±ì‹ 

</script>
{% endblock %}