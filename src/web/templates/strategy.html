{% extends "layout.html" %}

{% block content %}
<div class="h-full flex flex-col space-y-3 overflow-auto" style="height: calc(100vh - 120px)">

    <!-- Header -->
    <div class="flex items-center justify-between flex-shrink-0">
        <div class="flex items-center space-x-3">
            <h1 class="text-lg font-bold text-white">ğŸ“‹ AI Daily Report</h1>
            <span id="report-time" class="text-xs text-gray-500">ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘</span>
        </div>
        <button onclick="loadReport()"
            class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-white rounded transition">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="flex-1 flex items-center justify-center">
        <div class="text-center">
            <div class="text-4xl mb-3">ğŸŒ™</div>
            <p class="text-gray-400 text-sm">Off-Market ë¶„ì„ ë°ì´í„°ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-gray-600 text-xs mt-1">ì¥ ë§ˆê° í›„ ìë™ìœ¼ë¡œ 6ê°œ ë¶„ì„ì´ ì‹¤í–‰ë©ë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- Report Content (hidden until data loaded) -->
    <div id="report-content" class="hidden space-y-3 flex-1">

        <!-- KPI Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 flex-shrink-0">
            <!-- AI Accuracy -->
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">ğŸ¯ AI ì •í™•ë„</div>
                <div id="kpi-accuracy" class="text-2xl font-bold text-green-400">--%</div>
                <div id="kpi-accuracy-sub" class="text-xs text-gray-500 mt-1">-- ì ì¤‘</div>
            </div>
            <!-- Market Sentiment -->
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">ğŸ“ˆ ì‹œì¥ ì‹¬ë¦¬</div>
                <div id="kpi-sentiment" class="text-2xl font-bold text-gray-400">--</div>
                <div id="kpi-sentiment-sub" class="text-xs text-gray-500 mt-1">ë¶„ì„ ëŒ€ê¸°</div>
            </div>
            <!-- Risk Level -->
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">âš ï¸ ë¦¬ìŠ¤í¬</div>
                <div id="kpi-risk" class="text-2xl font-bold text-yellow-400">--</div>
                <div id="kpi-risk-sub" class="text-xs text-gray-500 mt-1">ê¸€ë¡œë²Œ ë¶„ì„ ê¸°ì¤€</div>
            </div>
            <!-- Data Stats -->
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="text-xs text-gray-500 mb-1">ğŸ“Š ë°ì´í„° í˜„í™©</div>
                <div id="kpi-data" class="text-sm font-bold text-blue-400 mt-1">--</div>
                <div id="kpi-data-sub" class="text-xs text-gray-500 mt-1">ìºì‹œ ìƒíƒœ</div>
            </div>
        </div>

        <!-- Global Market + Pre-Market Picks -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <!-- Global Market (3 cols) -->
            <div class="md:col-span-3 bg-gray-800 rounded-lg p-4 border border-gray-700">
                <h2 class="text-xs font-semibold text-gray-500 uppercase mb-3">ğŸŒ ê¸€ë¡œë²Œ ì‹œì¥ í˜„í™©</h2>
                <div id="global-indices" class="space-y-1.5 mb-3">
                    <div class="text-xs text-gray-600">ë¡œë”© ì¤‘...</div>
                </div>
                <div id="global-ai-summary" class="bg-gray-900/50 rounded p-3 border border-gray-700/50">
                    <div class="text-xs text-gray-500 mb-1">ğŸ¤– AI ì „ë§</div>
                    <div id="ai-outlook" class="text-xs text-gray-300 leading-relaxed">ë¶„ì„ ëŒ€ê¸°</div>
                    <div id="ai-recommended" class="mt-2 text-xs text-gray-500"></div>
                    <div id="ai-sectors" class="mt-1 text-xs text-gray-500"></div>
                </div>
            </div>
            <!-- Pre-Market Picks (2 cols) -->
            <div class="md:col-span-2 bg-gray-800 rounded-lg p-4 border border-purple-900/30">
                <h2 class="text-xs font-semibold text-purple-400 uppercase mb-3">â­ í”„ë¦¬ë§ˆì¼“ ì¶”ì²œ</h2>
                <div id="premarket-picks" class="space-y-2">
                    <div class="text-xs text-gray-600">ì¶”ì²œ ëŒ€ê¸°</div>
                </div>
            </div>
        </div>

        <!-- Technical Signals + Market Movers -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- Technical Signals -->
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <h2 class="text-xs font-semibold text-gray-500 uppercase mb-3">ğŸ”¬ ê¸°ìˆ ì  ì‹ í˜¸ ìš”ì•½</h2>
                <div id="ta-signals" class="grid grid-cols-5 gap-2">
                    <div class="text-xs text-gray-600 col-span-5">ë°ì´í„° ì—†ìŒ</div>
                </div>
            </div>
            <!-- Market Movers -->
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <h2 class="text-xs font-semibold text-gray-500 uppercase mb-3">ğŸ“° ì£¼ìš” ê¸‰ë“±ë½ ì¢…ëª©</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div class="text-xs text-green-400 font-semibold mb-2">ğŸŸ¢ ê¸‰ë“±</div>
                        <div id="movers-up" class="space-y-1">
                            <div class="text-xs text-gray-600">--</div>
                        </div>
                    </div>
                    <div>
                        <div class="text-xs text-red-400 font-semibold mb-2">ğŸ”´ ê¸‰ë½</div>
                        <div id="movers-down" class="space-y-1">
                            <div class="text-xs text-gray-600">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Accuracy Details -->
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 flex-shrink-0">
            <h2 class="text-xs font-semibold text-gray-500 uppercase mb-3">ğŸ¯ AI íŒë‹¨ ì •í™•ë„ ìƒì„¸</h2>
            <div id="accuracy-details" class="flex flex-wrap gap-2">
                <div class="text-xs text-gray-600">ê±°ë˜ ê¸°ë¡ ì—†ìŒ</div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- Strategy Management Section (always shown) -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="space-y-3 mt-2">

        <!-- Active Strategies -->
        <div class="bg-gray-800 rounded-lg p-4 border border-blue-900/30">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-xs font-semibold text-blue-400 uppercase">ğŸ§  í™œì„± ì „ëµ</h2>
                <span id="strategy-count" class="text-[10px] text-gray-500">0ê°œ</span>
            </div>
            <div id="strategy-list" class="space-y-2">
                <div class="text-xs text-gray-600 text-center py-4">
                    ì•„ì§ í•™ìŠµëœ ì „ëµì´ ì—†ìŠµë‹ˆë‹¤<br>
                    <span class="text-gray-700">Off-Market ë¶„ì„ ì™„ë£Œ í›„ ìë™ ìƒì„±ë©ë‹ˆë‹¤</span>
                </div>
            </div>
        </div>

        <!-- Learned Patterns -->
        <div class="bg-gray-800 rounded-lg p-4 border border-green-900/30">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-xs font-semibold text-green-400 uppercase">ğŸ“ˆ í•™ìŠµëœ ë§¤ë§¤ íŒ¨í„´</h2>
                <span id="pattern-count" class="text-[10px] text-gray-500">0ê±´</span>
            </div>
            <div id="pattern-list" class="space-y-2">
                <div class="text-xs text-gray-600 text-center py-4">
                    ë§¤ë§¤ ê¸°ë¡ì´ ìŒ“ì´ë©´ ìë™ìœ¼ë¡œ íŒ¨í„´ì´ í•™ìŠµë©ë‹ˆë‹¤
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const MARKET_FLAGS = { KR: 'ğŸ‡°ğŸ‡·', JP: 'ğŸ‡¯ğŸ‡µ', CN: 'ğŸ‡¨ğŸ‡³', HK: 'ğŸ‡­ğŸ‡°', US: 'ğŸ‡ºğŸ‡¸' };
    const INDEX_NAMES = {
        '^GSPC': 'S&P 500', '^DJI': 'Dow Jones', '^IXIC': 'NASDAQ',
        '^N225': 'Nikkei 225', '^KS11': 'KOSPI', '^HSI': 'Hang Seng', '000001.SS': 'Shanghai'
    };
    const INDEX_FLAGS = {
        '^GSPC': 'ğŸ‡ºğŸ‡¸', '^DJI': 'ğŸ‡ºğŸ‡¸', '^IXIC': 'ğŸ‡ºğŸ‡¸',
        '^N225': 'ğŸ‡¯ğŸ‡µ', '^KS11': 'ğŸ‡°ğŸ‡·', '^HSI': 'ğŸ‡­ğŸ‡°', '000001.SS': 'ğŸ‡¨ğŸ‡³'
    };
    const TYPE_LABELS = { market: 'ì‹œì¥ì „ëµ', sector: 'ì„¹í„°', pattern: 'íŒ¨í„´', custom: 'ì‚¬ìš©ì' };

    let refreshTimer = null;

    async function loadReport() {
        try {
            const [reportRes, stratRes] = await Promise.all([
                fetch('/api/offmarket/status'),
                fetch('/api/strategies')
            ]);
            const reportData = await reportRes.json();
            const stratData = await stratRes.json();
            renderReport(reportData);
            renderStrategies(stratData.strategies || []);
            renderPatterns(stratData.patterns || []);
        } catch (e) {
            console.error('Report load error:', e);
        }
    }

    function renderReport(d) {
        const hasData = d.candle_cache_count > 0 || d.ta_cache_count > 0 || d.news_count > 0
            || (d.ai_stats && d.ai_stats.total > 0) || (d.premarket_picks && d.premarket_picks.length > 0);

        document.getElementById('empty-state').classList.toggle('hidden', hasData);
        document.getElementById('report-content').classList.toggle('hidden', !hasData);
        if (!hasData) return;

        // Update time
        if (d.state && d.state.last_run) {
            document.getElementById('report-time').textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + d.state.last_run;
        }

        // KPI: Accuracy
        if (d.ai_stats && d.ai_stats.total > 0) {
            const acc = d.ai_stats.accuracy || 0;
            const el = document.getElementById('kpi-accuracy');
            el.textContent = acc.toFixed(1) + '%';
            el.className = 'text-2xl font-bold ' + (acc >= 60 ? 'text-green-400' : acc >= 40 ? 'text-yellow-400' : 'text-red-400');
            document.getElementById('kpi-accuracy-sub').textContent =
                `${d.ai_stats.correct || 0}/${d.ai_stats.total} ì ì¤‘`;
        }

        // KPI: Sentiment
        if (d.global_analysis && d.global_analysis.ai_analysis) {
            const ai = d.global_analysis.ai_analysis;
            const sentEl = document.getElementById('kpi-sentiment');
            const risk = (ai.risk_level || 'unknown').toUpperCase();
            const summary = (ai.summary || '').toLowerCase();
            let sentiment = 'NEUTRAL', sentColor = 'text-gray-400';
            if (summary.includes('ê°•ì„¸') || summary.includes('ìƒìŠ¹') || summary.includes('ê¸ì •') || summary.includes('bullish')) {
                sentiment = 'BULLISH ğŸ“ˆ'; sentColor = 'text-green-400';
            } else if (summary.includes('ì•½ì„¸') || summary.includes('í•˜ë½') || summary.includes('ë¶€ì •') || summary.includes('bearish')) {
                sentiment = 'BEARISH ğŸ“‰'; sentColor = 'text-red-400';
            }
            sentEl.textContent = sentiment;
            sentEl.className = 'text-2xl font-bold ' + sentColor;
            document.getElementById('kpi-sentiment-sub').textContent = 'AI ê¸€ë¡œë²Œ ë¶„ì„ ê¸°ë°˜';

            const riskEl = document.getElementById('kpi-risk');
            riskEl.textContent = risk;
            riskEl.className = 'text-2xl font-bold ' +
                (risk === 'LOW' ? 'text-green-400' : risk === 'HIGH' ? 'text-red-400' : 'text-yellow-400');
        }

        // KPI: Data stats
        document.getElementById('kpi-data').textContent =
            `ìº”ë“¤ ${d.candle_cache_count} | TA ${d.ta_cache_count} | ë‰´ìŠ¤ ${d.news_count}`;

        // Global Indices
        if (d.global_analysis && d.global_analysis.indices) {
            const idx = d.global_analysis.indices;
            let html = '';
            for (const [sym, data] of Object.entries(idx)) {
                const name = INDEX_NAMES[sym] || sym;
                const flag = INDEX_FLAGS[sym] || 'ğŸ³ï¸';
                const pct = data.change_pct || 0;
                const price = data.price || 0;
                const color = pct > 0 ? 'text-green-400' : pct < 0 ? 'text-red-400' : 'text-gray-400';
                const sign = pct > 0 ? '+' : '';
                html += `<div class="flex items-center justify-between py-1 border-b border-gray-700/50">
                <span class="text-xs text-gray-300">${flag} ${name}</span>
                <div class="flex items-center space-x-3">
                    <span class="text-xs text-gray-400">${price.toLocaleString(undefined, { maximumFractionDigits: 0 })}</span>
                    <span class="text-xs font-medium ${color} w-16 text-right">${sign}${pct.toFixed(2)}%</span>
                </div>
            </div>`;
            }
            document.getElementById('global-indices').innerHTML = html || '<div class="text-xs text-gray-600">ì§€ìˆ˜ ë°ì´í„° ì—†ìŒ</div>';

            if (d.global_analysis.ai_analysis) {
                const ai = d.global_analysis.ai_analysis;
                document.getElementById('ai-outlook').textContent = ai.summary || 'ë¶„ì„ ì—†ìŒ';
                if (ai.recommended_markets && ai.recommended_markets.length > 0) {
                    document.getElementById('ai-recommended').innerHTML =
                        'ì¶”ì²œ ì‹œì¥: ' + ai.recommended_markets.map(m => `<span class="text-blue-400">${MARKET_FLAGS[m] || ''} ${m}</span>`).join(', ');
                }
                if (ai.sector_outlook) {
                    const sectors = Object.entries(ai.sector_outlook).map(([k, v]) => {
                        const c = v === 'bullish' ? 'text-green-400' : v === 'bearish' ? 'text-red-400' : 'text-gray-400';
                        return `<span class="${c}">${k}: ${v}</span>`;
                    }).join(' Â· ');
                    document.getElementById('ai-sectors').innerHTML = 'ì„¹í„°: ' + sectors;
                }
            }
        }

        // Pre-Market Picks
        if (d.premarket_picks && d.premarket_picks.length > 0) {
            let html = '';
            d.premarket_picks.forEach((p, i) => {
                const flag = MARKET_FLAGS[p.market] || 'ğŸ³ï¸';
                html += `<div class="bg-gray-900/50 rounded p-2.5 border border-gray-700/50">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs font-semibold text-white">${i + 1}. ${flag} ${p.name || p.symbol}</span>
                    <span class="text-[10px] text-gray-500">${p.symbol}</span>
                </div>
                ${p.entry_price ? `<div class="text-[10px] text-gray-400">ì§„ì…: ${p.entry_price} Â· ëª©í‘œ: ${p.target_price || '--'}</div>` : ''}
                ${p.strategy ? `<div class="text-[10px] text-purple-300 mt-0.5">${p.strategy}</div>` : ''}
            </div>`;
            });
            document.getElementById('premarket-picks').innerHTML = html;
        }

        // Technical Signals
        if (d.ta_cache_count > 0) {
            const markets = ['KR', 'JP', 'CN', 'HK', 'US'];
            const flags = { KR: 'ğŸ‡°ğŸ‡· í•œêµ­', JP: 'ğŸ‡¯ğŸ‡µ ì¼ë³¸', CN: 'ğŸ‡¨ğŸ‡³ ì¤‘êµ­', HK: 'ğŸ‡­ğŸ‡° í™ì½©', US: 'ğŸ‡ºğŸ‡¸ ë¯¸êµ­' };
            let html = '';
            markets.forEach(m => {
                html += `<div class="bg-gray-900/50 rounded p-2.5 border border-gray-700/50 text-center">
                <div class="text-xs font-semibold text-gray-300 mb-1">${flags[m]}</div>
                <div class="text-[10px] text-gray-500">TA ë¶„ì„ ì™„ë£Œ</div>
            </div>`;
            });
            document.getElementById('ta-signals').innerHTML = html;
        }

        // Market Movers
        if (d.global_analysis && d.global_analysis.indices) {
            const entries = Object.entries(d.global_analysis.indices);
            const sorted = entries.sort((a, b) => (b[1].change_pct || 0) - (a[1].change_pct || 0));
            const gainers = sorted.filter(e => (e[1].change_pct || 0) > 0);
            const losers = sorted.filter(e => (e[1].change_pct || 0) < 0).reverse();

            document.getElementById('movers-up').innerHTML = gainers.length ? gainers.slice(0, 5).map(([sym, data]) => {
                const name = INDEX_NAMES[sym] || sym;
                return `<div class="flex items-center justify-between">
                <span class="text-xs text-gray-300">${name}</span>
                <span class="text-xs font-medium text-green-400">+${(data.change_pct || 0).toFixed(2)}%</span>
            </div>`;
            }).join('') : '<div class="text-xs text-gray-600">--</div>';

            document.getElementById('movers-down').innerHTML = losers.length ? losers.slice(0, 5).map(([sym, data]) => {
                const name = INDEX_NAMES[sym] || sym;
                return `<div class="flex items-center justify-between">
                <span class="text-xs text-gray-300">${name}</span>
                <span class="text-xs font-medium text-red-400">${(data.change_pct || 0).toFixed(2)}%</span>
            </div>`;
            }).join('') : '<div class="text-xs text-gray-600">--</div>';
        }

        // Accuracy Details
        if (d.ai_stats && d.ai_stats.details && d.ai_stats.details.length > 0) {
            let html = '';
            d.ai_stats.details.forEach(t => {
                const icon = t.verdict === 'correct' ? 'âœ…' : t.verdict === 'stop_loss' || t.verdict === 'loss' ? 'âŒ' : 'âšª';
                const pnl = t.pnl_pct || 0;
                const color = pnl > 0 ? 'text-green-400' : pnl < -1 ? 'text-red-400' : 'text-gray-400';
                const sign = pnl > 0 ? '+' : '';
                html += `<div class="bg-gray-900/50 rounded px-2.5 py-1.5 border border-gray-700/50 flex items-center space-x-1.5">
                <span class="text-xs">${icon}</span>
                <span class="text-xs text-gray-300">${t.symbol || '??'}</span>
                <span class="text-xs font-medium ${color}">${sign}${pnl.toFixed(1)}%</span>
            </div>`;
            });
            document.getElementById('accuracy-details').innerHTML = html;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Strategy Management
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderStrategies(strategies) {
        document.getElementById('strategy-count').textContent = `${strategies.length}ê°œ`;

        if (!strategies.length) {
            document.getElementById('strategy-list').innerHTML =
                `<div class="text-xs text-gray-600 text-center py-4">
                ì•„ì§ í•™ìŠµëœ ì „ëµì´ ì—†ìŠµë‹ˆë‹¤<br>
                <span class="text-gray-700">Off-Market ë¶„ì„ ì™„ë£Œ í›„ ìë™ ìƒì„±ë©ë‹ˆë‹¤</span>
            </div>`;
            return;
        }

        let html = '';
        strategies.forEach(s => {
            const active = s.active !== false;
            const typeLabel = TYPE_LABELS[s.type] || s.type;
            const flag = MARKET_FLAGS[s.market] || 'ğŸŒ';
            const total = (s.success_count || 0) + (s.fail_count || 0);
            const winRate = total > 0 ? `ìŠ¹ë¥  ${((s.success_count / total) * 100).toFixed(0)}%` : '';
            const stats = total > 0 ? `ì„±ê³µ ${s.success_count}íšŒ / ì‹¤íŒ¨ ${s.fail_count}íšŒ ${winRate ? `(${winRate})` : ''}` : '';

            html += `<div class="bg-gray-900/50 rounded p-3 border ${active ? 'border-blue-800/40' : 'border-gray-700/30 opacity-50'}">
            <div class="flex items-center justify-between mb-1">
                <div class="flex items-center space-x-2">
                    <button onclick="toggleStrategy('${s.id}', ${!active})"
                        class="w-9 h-5 rounded-full relative transition-colors ${active ? 'bg-blue-600' : 'bg-gray-600'}"
                        title="${active ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}">
                        <span class="absolute top-0.5 ${active ? 'right-0.5' : 'left-0.5'} w-4 h-4 bg-white rounded-full transition-all shadow"></span>
                    </button>
                    <span class="text-xs font-semibold text-white">${flag} ${s.name || 'ì „ëµ'}</span>
                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-700 text-gray-400">${typeLabel}</span>
                </div>
                <button onclick="deleteStrategy('${s.id}')" class="text-gray-600 hover:text-red-400 transition text-xs" title="ì‚­ì œ">ğŸ—‘ï¸</button>
            </div>
            <div class="text-[10px] text-gray-400 ml-11">${s.description || ''}</div>
            ${s.conditions ? `<div class="text-[10px] text-gray-500 ml-11 mt-0.5">ì¡°ê±´: ${s.conditions}</div>` : ''}
            ${stats ? `<div class="text-[10px] text-gray-500 ml-11 mt-0.5">${stats}</div>` : ''}
        </div>`;
        });
        document.getElementById('strategy-list').innerHTML = html;
    }

    function renderPatterns(patterns) {
        document.getElementById('pattern-count').textContent = `${patterns.length}ê±´`;

        if (!patterns.length) {
            document.getElementById('pattern-list').innerHTML =
                `<div class="text-xs text-gray-600 text-center py-4">ë§¤ë§¤ ê¸°ë¡ì´ ìŒ“ì´ë©´ ìë™ìœ¼ë¡œ íŒ¨í„´ì´ í•™ìŠµë©ë‹ˆë‹¤</div>`;
            return;
        }

        let html = '';
        patterns.slice().reverse().forEach(p => {
            const icon = p.result === 'success' ? 'âœ…' : p.result === 'fail' ? 'âŒ' : 'â³';
            const flag = MARKET_FLAGS[p.market] || 'ğŸ³ï¸';
            const pnl = p.pnl_pct || 0;
            const pnlColor = pnl > 0 ? 'text-green-400' : pnl < 0 ? 'text-red-400' : 'text-gray-400';
            const pnlSign = pnl > 0 ? '+' : '';

            // Candle trend arrows
            const snap = p.candle_snapshot || {};
            const before = snap.before_5d || [];
            const arrows = before.slice(-5).map(c =>
                c.close >= c.open ? '<span class="text-green-400">â†‘</span>' : '<span class="text-red-400">â†“</span>'
            ).join('');

            const ind = (snap.indicators || {});
            const rsi = ind.rsi ? `RSI:${ind.rsi}` : '';
            const ma = ind.ma5_vs_ma20 === 'cross_up' ? 'ê³¨ë“ í¬ë¡œìŠ¤' :
                ind.ma5_vs_ma20 === 'cross_down' ? 'ë°ë“œí¬ë¡œìŠ¤' :
                    ind.ma5_vs_ma20 === 'above' ? 'MAâ–²' : ind.ma5_vs_ma20 === 'below' ? 'MAâ–¼' : '';

            html += `<div class="bg-gray-900/50 rounded p-2.5 border border-gray-700/50">
            <div class="flex items-center justify-between mb-0.5">
                <span class="text-xs font-semibold text-white">${icon} ${flag} ${p.name || p.symbol}</span>
                <span class="text-xs font-medium ${pnlColor}">${p.result === 'pending' ? 'ì§„í–‰ì¤‘' : `${pnlSign}${pnl.toFixed(1)}%`}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-[10px] text-purple-300">${p.pattern_label || '-'}</span>
                <span class="text-[10px] text-gray-500">${[rsi, ma].filter(Boolean).join(' Â· ')}</span>
            </div>
            ${arrows ? `<div class="text-[10px] text-gray-500 mt-0.5">ì§„ì… ì „: ${arrows}</div>` : ''}
        </div>`;
        });
        document.getElementById('pattern-list').innerHTML = html;
    }

    async function toggleStrategy(id, active) {
        try {
            await fetch(`/api/strategies/${id}/toggle?active=${active}`, { method: 'PUT' });
            loadReport();
        } catch (e) { console.error('Toggle error:', e); }
    }

    async function deleteStrategy(id) {
        if (!confirm('ì´ ì „ëµì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            await fetch(`/api/strategies/${id}`, { method: 'DELETE' });
            loadReport();
        } catch (e) { console.error('Delete error:', e); }
    }

    // Auto-refresh
    loadReport();
    refreshTimer = setInterval(loadReport, 60000);
</script>
{% endblock %}